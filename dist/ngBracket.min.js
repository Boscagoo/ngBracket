/*! ngBracket 16-10-2014 */
var app=angular.module("ngBracket",[]);app.findParentByAttribute=function(a,b,c){if(null===a||null===b||null===c)return null;for(var d=null,e=angular.element(a);null!==e.parent()&&e.parent().length>0;)if(e=e.parent(),e.attr(b)===c){d=e;break}return d},app.filter("iif",function(){return function(a,b,c){return a?b:c}}),app.filter("getById",function(){return function(a,b){for(var c=0;c<a.length;c++)if(a[c].id==b)return a[c];return null}}),app.findFirstRound=function(a){for(var b=0;b<a.length;b++)if("L"!==a[b][0].meta.matchId.slice(-1))return b;return null},app.factory("data",function(){var a=null,b=null;return{getTeams:function(){return a.teams},getMatches:function(){return a.tournament.matches},getTournamentType:function(){return a.tournament.type},getProperties:function(){return a.tournament.properties},getOptions:function(){return a.options},updateTournament:function(b,c,d,e,f){function g(a,b,c,d){null!==a&&(-1!==c.indexOf(a.team1.id)?a.team1.id=b:-1!==c.indexOf(a.team2.id)?a.team2.id=b:!(d||v>o)||a.team1.id&&0!==a.team1.id.length?a.team2.id=b:a.team1.id=b)}function h(a,b){for(var c=0;c<l[b].length;c++)if(l[b][c].meta.matchType==a)return l[b][c];return null}"Not started"===a.tournament.properties.status&&(a.tournament.properties.status="In progress");var i,j,k,l=a.tournament.matches,m=b.meta.matchId.split("-"),n=parseInt(m[1]),o=parseInt(m[2]),p=m.length>3&&"L"===m[3],q=n===l.length-1;if("DE"===a.tournament.type&&"finals"===b.meta.matchType){var r=l.length-2;k=l[r].length-1,j=l[r][k].team1.score>l[r][k].team2.score?l[r][k].team1.id:l[r][k].team2.id,a.tournament.properties.finals2=d!=j;var s=h("finals2",l.length-1);return void(d!=j?null!==s&&(s.team1.id=b.team1.id,s.team2.id=b.team2.id):null!==s&&(s.team1.id="",s.team2.id="",s.team1.score="",s.team2.score=""))}if(("SE"!==a.tournament.type||n!==l.length)&&("DE"!==a.tournament.type||"bronze"!==b.meta.matchType&&"finals2"!==b.meta.matchType)){var t=[b.team1.id,b.team2.id];if(null!==e&&e.length>0&&t.push(e),"SE"===a.tournament.type&&q&&l[l.length-1].length>1||"DE"===a.tournament.type&&p&&(q||n===l.length-2)){k=l[l.length-1].length;var u=h("bronze",l.length-1);g(u,d,t,1===o)}var v=0,w=l[n],x=p&&q;for(i=0;i<w.length;i++)if(2!=w[i].meta.matchType){if(p&&"L"!==w[i].meta.matchId.slice(-1)&&!q)continue;if(v+=1==w[i].meta.matchType?1:2,v>=o){g(w[i],c,t,x);break}}if(f){var y=parseInt(b.meta.loserMatchId.split("-")[1])-1,z=l[y];for(i=z.length-1;i>=0;i--){if(z[i].meta.team1Parent===b.meta.matchId){z[i].team1.id=d;break}if(z[i].meta.team2Parent===b.meta.matchId){z[i].team2.id=d;break}}}}},loadTournament:function(c){a=c,b="DE"===a.tournament.type?angular.module("ngBracket").findFirstRound(a.tournament.matches):null}}}).factory("connectorService",["data",function(a){return{findConnectingMatchId:function(b){var c,d,e=b.meta.matchId.split("-"),f=parseInt(e[1]),g=parseInt(e[2]),h="L"===b.meta.matchId.slice(-1)?"-L":"",i=0,j=a.getMatches(),k=0;if("finals2"===b.meta.matchType)d="match-"+f+"-1";else{if(h.length>0)for(c=0;c<j[f-1].length;c++)if("L"===j[f-1][c].meta.matchId.slice(-1)){k=c;break}for(c=0;g>c;c++)2!=j[f-1][c+k].meta.matchType&&(i+=1==j[f-1][c+k].meta.matchType||c+1==g?1:2);d="match-"+(f-1)+"-"+i+h}return d},findConnectingMatch:function(a){return angular.element(document.getElementById(this.findConnectingMatchId(a)))},findChildMatch:function(a){for(var b=angular.element(a).children(),c=0;c<b.length;c++)if(angular.element(b[c]).hasClass("match"))return angular.element(b[c])}}}]).factory("highlight",function(){var a={teamId:null};return{mapHighlight:function(){return a},setHighlight:function(b){a.teamId=b&&b.length>0?b:null}}}).factory("layoutService",["data",function(a){function b(a){return"L"!==a.meta.matchId.slice(-1)}function c(a){return"L"===a.meta.matchId.slice(-1)}function d(a){var b=document.getElementsByClassName("roundHeader")[0],c=document.getElementsByClassName("round")[0];matchEl=document.createElement("div"),matchEl.style.visibility="hidden",matchEl.className="match",b&&c&&(c.appendChild(matchEl),document.all?(a.matchHeight=matchEl.currentStyle.height,a.matchWidth=matchEl.currentStyle.width,a.matchMarginH=parseInt(matchEl.currentStyle.marginRight),a.matchMarginV=parseInt(matchEl.currentStyle.marginTop)+parseInt(matchEl.currentStyle.marginBottom),a.borderThickness=parseInt(matchEl.currentStyle.borderWidth),a.roundMarginTop=b.currentStyle.height+parseInt(b.currentStyle.marginTop)+parseInt(b.currentStyle.marginBottom)):(a.matchHeight=parseInt(document.defaultView.getComputedStyle(matchEl,"").getPropertyValue("height").replace("px","")),a.matchWidth=parseInt(document.defaultView.getComputedStyle(matchEl,"").getPropertyValue("width").replace("px","")),a.matchMarginH=parseInt(document.defaultView.getComputedStyle(matchEl,"").getPropertyValue("margin-right").replace("px","")),a.matchMarginV=parseInt(document.defaultView.getComputedStyle(matchEl,"").getPropertyValue("margin-top"))+parseInt(document.defaultView.getComputedStyle(matchEl,"").getPropertyValue("margin-bottom")),a.borderThickness=parseInt(document.defaultView.getComputedStyle(matchEl,"").getPropertyValue("border-right-width")),a.roundMarginTop=parseInt(document.defaultView.getComputedStyle(b,"").getPropertyValue("height").replace("px",""))+parseInt(document.defaultView.getComputedStyle(b,"").getPropertyValue("margin-top"))+parseInt(document.defaultView.getComputedStyle(b,"").getPropertyValue("margin-bottom"))),c.removeChild(matchEl),g=!0)}function e(d){var e=a.getMatches();if(!e)return d.bracket.width="0 px",void(d.bracket.height="0 px");var f=0;if("DE"===a.getTournamentType()){var g=angular.module("ngBracket").findFirstRound(e);g&&(d.startingRound=g+1,f=Math.max(e[g].filter(b).length,e[g+1].filter(b).length),f+=Math.max(e[0].filter(c).length,e[1].filter(c).length)),d.lbOffset=a.getProperties().lbOffset*(d.matchHeight+d.matchMarginV)+d.roundMarginTop,f+=.5}f=0!==f?f:e[0].length>e[1].length?e[0].length:e[1].length,d.bracket.height=String(f*(d.matchHeight+d.matchMarginV)+d.roundMarginTop)+"px",d.bracket.width=String(e.length*(d.matchWidth+d.matchMarginH))+"px"}var f={matchHeight:null,matchWidth:null,matchMarginH:null,matchMarginV:null,borderThickness:null,roundMarginTop:null,startingRound:null,lbOffset:null,bracket:{width:null,height:null}},g=!1;return{getProperties:function(){return g||(d(f),e(f)),f},refresh:function(){e(f)}}}]),app.directive("ngbracket",["data","layoutService",function(a,b){return{restrict:"E",templateUrl:"partials/bracket.html",replace:!1,scope:{bracketData:"="},controller:["$scope",function(c){c.bracketData&&(c.bracketData.reload=function(){a.loadTournament(c.bracketData),c.layoutProperties||(c.layoutProperties=b.getProperties()),b.refresh()})}]}}]).directive("doFocus",function(){return{restrict:"A",link:function(a,b){b&&(b[0].focus(),b[0].select())}}}).directive("teamContextMenu",["data",function(a){return{restrict:"A",scope:!1,link:function(b,c){function d(a){e.onTeamRightClick(a,b.team)}var e=a.getOptions();e.onTeamRightClick&&c.bind("contextmenu",d),b.$on("$destroy",function(){c.unbind("contextmenu",d)})}}}]).directive("match",["connectorService","layoutService","data","$filter","highlight",function(a,b,c,d,e){return{restrict:"E",scope:!1,templateUrl:"partials/match.html",replace:!0,link:{pre:function(f,g){f.getTeamDetails=function(a){return d("getById")(c.getTeams(),a)},f.highlight=e.mapHighlight(),f.team1Details=f.getTeamDetails(f.match.team1.id),f.team2Details=f.getTeamDetails(f.match.team2.id);var h=f.$watch("match.team1",function(a){a&&(f.team1Details=f.getTeamDetails(f.match.team1.id))},!0),i=f.$watch("match.team2",function(a){a&&(f.team2Details=f.getTeamDetails(f.match.team2.id))},!0),j=parseInt(f.match.meta.matchId.split("-")[1]),k=parseInt(f.match.meta.matchId.split("-")[2]),l=b.getProperties();f.match.meta.team1Parent&&(f.team1Description="Loser of Round "+(parseInt(f.match.meta.team1Parent.split("-")[1])-l.startingRound+1)+" match "+f.match.meta.team1Parent.split("-")[2]),f.match.meta.team2Parent&&(f.team2Description="Loser of Round "+(parseInt(f.match.meta.team2Parent.split("-")[1])-l.startingRound+1)+" match "+f.match.meta.team2Parent.split("-")[2]),"finals2"===f.match.meta.matchType&&0===f.match.team1.id.length&&0===f.match.team2.id.length&&(f.team1Description="Finals round 2 if necessary",f.prop=c.getProperties()),g.prop("id","match-"+j+"-"+k),"finals"==f.match.meta.matchType&&(f.finals=!0),g.css("left",l.matchMarginH/2+"px");var m="finals2"===f.match.meta.matchType&&"DE"===c.getTournamentType();m&&g.css("left",l.matchMarginH/2+l.matchMarginH+l.matchWidth+"px");var n=0,o="finals"===f.match.meta.matchType&&"DE"===c.getTournamentType(),p="L"===f.match.meta.matchId.slice(-1)||o?"-L":"";if(1===j||j===l.startingRound&&0===p.length){var q=f.match.meta.UIShiftDown?f.match.meta.UIShiftDown:0;n=(l.matchHeight+l.matchMarginV)*(k-1+q)+l.roundMarginTop}else if(2===f.match.meta.matchType)n=(l.matchHeight+l.matchMarginV)*(k-1)+l.roundMarginTop,p.length>0&&l.lbOffset>0&&n<l.lbOffset&&(n+=l.lbOffset-l.roundMarginTop);else if("bronze"===f.match.meta.matchType){f.bronzeMatch=!0;var r=angular.element(document.getElementById("match-"+j+"-1"));n=r.prop("offsetTop")+l.matchHeight+40}else if(m){var s=angular.element(document.getElementById("match-"+j+"-1"));n=s.prop("offsetTop")}else{var t=a.findConnectingMatch(f.match);if(n=angular.element(t[0].firstElementChild).prop("offsetTop"),1!=f.match.meta.matchType){var u=parseInt(t.scope().match.meta.matchId.split("-")[2]),v="match-"+(j-1)+"-"+(o?"1-L":u+1+p),w=angular.element(document.getElementById(v)),x=angular.element(w[0].firstElementChild).prop("offsetTop")+l.matchHeight;o?n+=(x-n)/4:n=n+(x-n)/2-l.matchHeight/2}}g.css("top",n+"px"),f.$on("$destroy",function(){h(),i()})},post:function(a,b){function d(){return{matchId:a.match.meta.matchId,team1:a.team1Details,team2:a.team2Details,results:a.match}}function e(a){g.onMatchClick(a,d())}function f(a){g.onMatchRightClick(a,d())}var g=c.getOptions();g.onMatchRightClick&&b.bind("contextmenu",f),g.onMatchClick&&b.bind("click",e),a.$on("$destroy",function(){b.unbind("contextmenu",f),b.unbind("click",e)})}}}}]).directive("score",["data",function(a){return{restrict:"E",scope:{team:"=",match:"=",results:"="},templateUrl:"partials/score.html",link:function(b){b.editScore=function(){b.match.team1.id&&b.match.team2.id&&(b.status="editable")},b.calculateResults=function(c){if("undefined"==typeof b.match.team1.score||""===b.match.team1.score||"undefined"==typeof b.match.team2.score||""===b.match.team2.score||b.match.team1.score===b.match.team2.score)return b.results.winner="",void(b.results.loser="");var d;b.match.team1.score>b.match.team2.score?(d=b.match.team1.id,b.results.loser=b.match.team2.id):(d=b.match.team2.id,b.results.loser=b.match.team1.id),b.results.winner=d;var e="DE"===a.getTournamentType()&&"L"!==b.match.meta.matchId.slice(-1);a.updateTournament(b.match,d,b.results.loser,c,e)},b.endEditScore=function(){b.status="uneditable",b.calculateResults(null)};var c=b.$watch("match.team1.id",function(a,c){a&&b.calculateResults(c)},!0),d=b.$watch("match.team2.id",function(a,c){a&&b.calculateResults(c)},!0);b.$on("$destroy",function(){c(),d()})},replace:!0}}]).directive("connectors",["connectorService","layoutService","$compile","data",function(a,b,c,d){return{restrict:"E",template:'<div class="connectors"></div>',replace:!0,scope:!1,link:function(e,f){function g(a,b,d,f,g,h,i){var j=null===g?"cMatch1":"cMatch"+g.toString(),k=null===g?h?"tbdB:match.team1.id.length === 0 && match.team2.id.length === 0":"":1==g?"tbdB:match.team1.id.length === 0":"tbdB:match.team2.id.length === 0",l=i?j+".team1.score > "+j+".team2.score && ":"",m=i?j+".team2.score > "+j+".team1.score && ":"",n="highlight: highlight.teamId !== null && ((match.team1.id === highlight.teamId || match.team2.id === highlight.teamId) && (("+l+j+".team1.id === highlight.teamId) || ("+m+j+".team2.id === highlight.teamId)))",o="finals2"===e.match.meta.matchType?",hidden:(prop.finals2 === false)":"",p='ng-class="{'+k+(k.length>0?", ":"")+n+o+'}"';return angular.element(c('<div class="connector" style="left:'+d+"px;top:"+f+"px;width:"+a+"px;height:"+b+'px" '+p+"></div>")(e))}if(2!=e.match.meta.matchType&&"bronze"!=e.match.meta.matchType){var h=b.getProperties(),i=parseInt(e.match.meta.matchId.split("-")[1]),j="L"===e.match.meta.matchId.slice(-1);if(i>1&&(j||!j&&i>h.startingRound)){var k=a.findChildMatch(f.parent()),l=angular.element(a.findConnectingMatch(e.match)[0].firstElementChild);e.cMatch1=l.scope().match;var m=k.prop("offsetLeft"),n=k.prop("offsetTop")+h.matchHeight/2;if(1===e.match.meta.matchType||"finals2"===e.match.meta.matchType){var o="L"===e.match.meta.matchId.slice(-1)||"finals2"===e.match.meta.matchType;return void f.append(g(h.matchMarginH-h.borderThickness,1,m-h.matchMarginH+h.borderThickness,n,null,o).addClass("connectorBottom"))}var p="DE"===d.getTournamentType()&&"finals"===e.match.meta.matchType,q=h.matchMarginH/2,r=n-l.prop("offsetTop")-h.matchHeight/2,s=m-q-h.borderThickness,t=n-r,u=g(q,r,s,t,1,null,p).addClass("connectorBottom connectorLeft");f.append(u),q=h.matchMarginH/2-h.borderThickness,s=s-q+h.borderThickness,f.append(g(q,1,s,t,1,null,p).addClass("connectorTop"));var v=l.scope().match.meta.matchId.split("-"),w="finals"===e.match.meta.matchType&&"DE"===d.getTournamentType(),x=v.length>3||w?"-L":"",y=v[0]+"-"+v[1]+"-"+(w?1:parseInt(v[2])+1)+x,z=angular.element(a.findChildMatch(document.getElementById(y)));e.cMatch2=z.scope().match,q=h.matchMarginH/2,r=z.prop("offsetTop")+h.matchHeight/2-n,s=m-q-h.borderThickness,t=n,f.append(g(q,r,s,t,2).addClass("connectorTop connectorLeft")),q=h.matchMarginH/2-h.borderThickness,s=s-q+h.borderThickness,t=n+r,f.append(g(q,1,s,t,2).addClass("connectorTop"))}}}}}]).directive("team",["data","highlight",function(a,b){return{restrict:"E",templateUrl:"partials/team.html",replace:!0,scope:{team:"=",teamdetails:"=",description:"="},link:function(c,d){c.highlight=c.$parent.highlight,c.results=c.$parent.results,c.match=c.$parent.match,c.highlightTrack=function(a){b.setHighlight(a)},c.editTeam=function(){"Not started"===a.getProperties().status&&c.team.id&&(c.status="editable")},c.endEditTeam=function(){c.status="uneditable"};var e=a.getOptions();e.onTeamClick&&d.bind("click",e.onTeamClick),c.$on("$destroy",function(){d.unbind("click",e.onTeamClick)})}}}]),angular.module("ngBracket").factory("tournamentGenerator",function(){return{newTournament:function(a,b,c){function d(a,b){return{team1:{id:"",score:""},team2:{id:"",score:""},meta:{matchId:"match-"+a+"-"+b},details:{}}}function e(a,b,c){for(var d=[],e=c?2*a-b:b,f=c?a/Math.abs(2*a-b):a/b,g=0;a>g;g++)d[g]=c?2:0;for(g=0;e>g;g++){var h=Math.round(g*f);d[h]=c?d[h]-1:d[h]+1}return d}function f(a,b,c){function f(a,b){var c,d=0;for(c=0;c<a.length;c++)2!=a[c].meta.matchType&&(d+=1==a[c].meta.matchType?1:2);for(c=d;c<b.length;c++)b[c].meta.UIShiftDown=b[c].meta.UIShiftDown?b[c].meta.UIShiftDown+1:1}var g,h,i=[],j=1,k=null,l=0;if(1===b){for(;2*j<a.length;)j*=2;var m=a.length-j;if(m>0){l=m-j/2;var n=0===l?j:l>0?j+2*l:j-2*Math.abs(l);k=a.slice(n,a.length),a.splice(n,a.length)}}for(g=0;g<a.length;g++){if(h=d(b,i.length+1),1===b){if(g%2!==0)continue;h.team1.id=a[g].id,h.team2.id=a[g+1].id}else if(g%2!==0)continue;i.push(h)}var o;if(1===b&&null!==k&&k.length>0){c.matches.push(i.slice()),c.properties.unbalanced=!0;var p=[];if(0===l)for(g=0;g<k.length;g++)h=d(b+1,p.length+1),h.team1.id=k[g].id,h.meta.matchType=1,p.push(h);else if(l>0){o=e(j/2,k.length,!1);var q=0;for(g=0;g<o.length;g++)h=d(b+1,p.length+1),1===o[g]&&(h.team1.id=k[q].id,h.meta.matchType=1,q+=1),p.push(h)}else if(0>l){o=e(j/2,k.length,!0);var r=0;for(g=0;j/2>g;g++)h=d(b+1,p.length+1),h.team1.id=k[r].id,h.meta.matchType=1,2===o[g]&&(h.team2.id=k[r+1].id,h.meta.matchType=2,f(p,i),r+=1),r+=1,p.push(h)}return a=null,p}return a=null,i}function g(a,b,c,f){var g,h,i,j,k=[];if(!(1===b&&f.matches.length>1||f.properties.unbalanced&&2===b)){var l=b>2&&f.properties.unbalanced&&f.matches[0].length!==f.matches[1].length?1:0,m=!0;if(b>1){var n=c.length-1;for(i=0;i<c[n].length;i++)if(!c[n][i].meta.matchType){m=!1;break}}if(m&&3===b&&(f.matches[0].length<f.matches[1].length||c[0].length===c[1].length)&&(m=!1),(b+l)%2!==0||m)if(f.properties.unbalanced&&2>=b)if(a.length===f.matches[0].length)g=a.length;else{if(a.length>f.matches[0].length){for(c[0]=[],c[1]=[],i=0;i<f.matches[0].length;i++)c[0].push(d(1,i+1+"-L"));var o=c[0].length>a.length/2;for(dist=e(a.length/2,c[0].length,o),i=0;i<a.length/2;i++)j=d(2,i+1+"-L"),o?1===dist[i]&&(j.meta.matchType=1):j.meta.matchType=1===dist[i]?1:2,c[1].push(j);if(!o&&dist.length>c[0].length){var p=0,q=0;for(i=0;i<dist.length;i++)1!==dist[i]?p+=1:(c[0][q].meta.UIShiftDown=p,q+=1)}return}if(a.length<f.matches[0].length){c[0]=[],c[1]=[];var r=0;for(i=0;i<a.length;i++)1===a[i].meta.matchType?(j=d(2,i+1+"-L"),j.meta.matchType=2,c[1].push(j),r+=1):(j=d(1,c[0].length+1+"-L"),j.meta.UIShiftDown=r,c[0].push(j),j=d(2,i+1+"-L"),j.meta.matchType=1,c[1].push(j));return}}else g=Math.floor(1===b?a.length/2:c[c.length-1].length/2);else g=Math.floor(c[c.length-1].length),h=!0;for(i=1;g>=i;i++)j=d(c.length+1,i+"-L"),h&&(j.meta.matchType=1),k.push(j);if(c.push(k),1===a.length)for(;1!==c[c.length-1].length||1!==c[c.length-2].length;){b+=1;var s=[];for(g=Math.floor((b+l)%2===0?c[c.length-1].length:c[c.length-1].length/2),h=(b+l)%2===0,0===g&&(g=1,h=!0),i=1;g>=i;i++)j=d(c.length+1,i+"-L"),h&&(j.meta.matchType=1),s.push(j);c.push(s)}}}var h={type:a,matches:[],properties:{status:"Not started"}};if(b.length<3)return h;for(var i=[],k=[],l=1;1===l||Math.floor(i.length)>1;){var m=i;1===l&&(m=b.slice()),i=f(m,l,h),"DE"===h.type&&g(i,l,k,h),h.matches.push(i.slice()),l=h.matches.length+1}if("DE"===h.type){for(var n=Math.max(h.matches[0].length,h.matches[1].length)+.5,o=0;o<k[0].length;o++)k[0][o].meta.UIShiftDown=isNaN(k[0][o].meta.UIShiftDown)?n:k[0][o].meta.UIShiftDown+n,h.properties.lbOffset=n;n=k.length-h.matches.length;var p,q,r,s=0;if(h.properties.unbalanced){if(h.matches[0].length===h.matches[1].length)for(o=0;2>o;o++)for(p=h.matches[o].length,j=0;j<h.matches[o].length;j++)q="match-"+(o+1+n)+"-"+(j+1),h.matches[o][j].meta.matchId=q,o>0?(k[0][p-1-j].meta.team2Parent=q,h.matches[o][j].meta.loserMatchId=k[0][p-1-j].meta.matchId):(k[0][j].meta.team1Parent=q,h.matches[o][j].meta.loserMatchId=k[0][j].meta.matchId);else if(h.matches[0].length>h.matches[1].length){var t=0,u=0;for(o=0;2>o;o++)for(p=h.matches[o].length,j=0;p>j;j++)h.matches[o][j].meta.matchId="match-"+(o+1+n)+"-"+(j+1),o>0&&(1===h.matches[o][j].meta.matchType?(k[o][j].meta.matchType=2,k[o][j].meta.team1Parent=h.matches[0][t].meta.matchId,k[o][j].meta.team2Parent="match-"+(o+1+n)+"-"+(p-j),h.matches[0][t].meta.loserMatchId=k[o][j].meta.matchId,h.matches[o][p-j-1].meta.loserMatchId=k[o][j].meta.matchId,t+=1):(k[o][j].meta.matchType=1,k[0][u].meta.team1Parent=h.matches[0][t].meta.matchId,k[0][u].meta.team2Parent=h.matches[0][t+1].meta.matchId,k[o][j].meta.team1Parent="match-"+(o+1+n)+"-"+(p-j),h.matches[0][t].meta.loserMatchId=k[0][u].meta.matchId,h.matches[0][t+1].meta.loserMatchId=k[0][u].meta.matchId,h.matches[o][p-j-1].meta.loserMatchId=k[o][j].meta.matchId,u+=1,t+=2))}else if(h.matches[0].length<h.matches[1].length){var v=!1;for(o=0;2>o;o++)for(p=h.matches[o].length,j=0;p>j;j++)if(q="match-"+(o+1+n)+"-"+(j+1),h.matches[o][j].meta.matchId=q,0===o)k[o][j].meta.team1Parent=q,h.matches[o][j].meta.loserMatchId=k[o][j].meta.matchId;else if(h.matches[o][j].meta.matchType)if(v)for(r=0;r<k[1].length;r++){if(!(1!==k[1][r].meta.matchType&&2!==k[1][r].meta.matchType||k[1][r].meta.team1Parent)){k[1][r].meta.team1Parent=q,h.matches[o][j].meta.loserMatchId=k[1][r].meta.matchId;break}if(2===k[1][r].meta.matchType&&!k[1][r].meta.team2Parent){k[1][r].meta.team2Parent=q,h.matches[o][j].meta.loserMatchId=k[1][r].meta.matchId;break}}else k[0][k[0].length-j-1].meta.team2Parent=q,h.matches[o][j].meta.loserMatchId=k[0][k[0].length-j-1].meta.matchId,v=j===k[0].length-1}s=2}for(o=s;o<h.matches.length;o++){var w=2>o?o:2*o-1,x=0;for(h.properties.unbalanced&&(w-=1,x=1),o===h.matches.length-1&&(w=k.length-1),p=h.matches[o].length,j=0;p>j;j++){var y="match-"+(w+1)+"-";for(y+=0===o?Math.floor(j/2)+1:(o+x)%2===0?j+1:p-j,y+="-L",q="match-"+(o+1+n)+"-"+(j+1),r=k[w].length-1;r>=0;r--)if(k[w][r].meta.matchId===y){k[w][r].meta.team1Parent?k[w][r].meta.team2Parent=q:k[w][r].meta.team1Parent=q;break}h.matches[o][j].meta.matchId=q,h.matches[o][j].meta.loserMatchId=y}}for(j=h.matches.length-1,o=k.length-1;o>=0;o--)j>=0?h.matches[j]=h.matches[j].concat(k[o]):h.matches.unshift(k[o]),j-=1;h.matches.push(new Array(d(h.matches.length+1,1)));var z=d(h.matches.length,h.matches[h.matches.length-1].length+1);z.meta.matchType="finals2",h.matches[h.matches.length-1].push(z)}if(h.matches[h.matches.length-1][0].meta.matchType="finals",c){var A=d(h.matches.length,h.matches[h.matches.length-1].length+1);A.meta.matchType="bronze",h.matches[h.matches.length-1].push(A)}return h},shuffle:function(a){if(a&&a.teams&&a.tournament&&"Not started"==a.tournament.properties.status){for(var b,c,d=a.tournament,e=a.teams.length,f=a.teams.slice();0!==e;)c=Math.floor(Math.random()*e),e-=1,b=f[e],f[e]=f[c],f[c]=b;var g,h=0,i="DE"===d.type?angular.module("ngBracket").findFirstRound(d.matches):0;for(g=0;g<d.matches[i].length&&"L"!==d.matches[i][g].meta.matchId.slice(-1);g++)d.matches[i][g].team1.id=f[h].id,d.matches[i][g].team2.id=f[h+1].id,h+=2;if(d.properties.unbalanced)for(i+=1,g=0;g<d.matches[i].length&&!(h>=f.length||"L"===d.matches[i][g].meta.matchId.slice(-1));g++)1===d.matches[i][g].meta.matchType?(d.matches[i][g].team1.id=f[h].id,h+=1):2===d.matches[i][g].meta.matchType&&(d.matches[i][g].team1.id=f[h].id,d.matches[i][g].team2.id=f[h+1].id,h+=2)}}}});