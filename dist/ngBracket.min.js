/*! ngBracket 23-05-2014 */
var myApp=angular.module("ngBracket",[]);myApp.filter("iif",function(){return function(a,b,c){return a?b:c}}),myApp.filter("getById",function(){return function(a,b){for(var c=0;c<a.length;c++)if(a[c].id==b)return a[c];return null}}),myApp.factory("highlight",function(){var a={teamId:null};return{mapHighlight:function(){return a},setHighlight:function(b){a.teamId=b&&b.length>0?b:null}}}),myApp.factory("data",["$rootScope",function(){var a={},b={};return{getParticipants:function(){return a},getMatches:function(){return b.matches},setParticipants:function(b){a=b},setTournament:function(a){b=a},updateTournament:function(a,c,d){var e=a.meta.matchId.split("-"),f=parseInt(e[1]),g=parseInt(e[2]);if(f!==b.matches.length)for(var h=0,i=b.matches[f],j=0;j<i.length;j++)if(2!=i[j].meta.matchType&&(h+=1==i[j].meta.matchType?1:2,h>=g)){var k=[a.team1.id,a.team2.id];null!==d&&d.length>0&&k.push(d),-1!==k.indexOf(i[j].team1.id)?i[j].team1.id=c:-1!==k.indexOf(i[j].team2.id)?i[j].team2.id=c:h>g&&(!i[j].team1.id||0===i[j].team1.id.length)?i[j].team1.id=c:i[j].team2.id=c;break}},loadTournament:function(){var a=JSON.parse('[{"name":"Austria","id":"1","flag":"countries/aut","members":[]},{"name":"Czech","id":"2","flag":"countries/cze","members":[]},{"name":"France","id":"3","flag":"countries/fra","members":[]},{"name":"Switzerland","id":"4","flag":"countries/sui","members":[]},{"name":"United States","id":"5","flag":"countries/usa","members":[]},{"name":"Sweden","id":"6","flag":"countries/swe","members":[]},{"name":"Finland","id":"7","flag":"countries/fin","members":[]},{"name":"Germany","id":"8","flag":"countries/ger","members":[]},{"name":"Russia","id":"9","flag":"countries/rus","members":[]},{"name":"Canada","id":"10","flag":"countries/can","members":[]},{"name":"United Kingdom","id":"11","flag":"countries/uk","members":[]},{"name":"China","id":"12","flag":"countries/chi","members":[]},{"name":"Denmark","id":"13","flag":"countries/den","members":[]}]'),b=JSON.parse('{"type":"SE","matches":[[{"team1":{"id":"1","score":""},"team2":{"id":"2","score":""},"meta":{"matchId":"match-1-1"},"details":{}},{"team1":{"id":"3","score":4},"team2":{"id":"4","score":2},"meta":{"matchId":"match-1-2"},"details":{}},{"team1":{"id":"5","score":""},"team2":{"id":"6","score":""},"meta":{"matchId":"match-1-3"},"details":{}},{"team1":{"id":"7","score":""},"team2":{"id":"8","score":""},"meta":{"matchId":"match-1-4"},"details":{}},{"team1":{"id":"9","score":3},"team2":{"id":"10","score":4},"meta":{"matchId":"match-1-5"},"details":{}}],[{"team1":{"id":"11","score":""},"team2":{"id":"","score":""},"meta":{"matchId":"match-2-1","matchType":1},"details":{}},{"team1":{"id":"12","score":""},"team2":{"id":"3","score":""},"meta":{"matchId":"match-2-2","matchType":1},"details":{}},{"team1":{"id":"","score":""},"team2":{"id":"","score":""},"meta":{"matchId":"match-2-3"},"details":{}},{"team1":{"id":"13","score":0},"team2":{"id":"10","score":2},"meta":{"matchId":"match-2-4","matchType":1},"details":{}}],[{"team1":{"id":"","score":""},"team2":{"id":"","score":""},"meta":{"matchId":"match-3-1"},"details":{}},{"team1":{"id":"","score":""},"team2":{"id":"10","score":""},"meta":{"matchId":"match-3-2"},"details":{}}],[{"team1":{"id":"","score":""},"team2":{"id":"","score":""},"meta":{"matchId":"match-4-1"},"details":{}}]]}');return this.setParticipants(a),this.setTournament(b),b}}}]),myApp.factory("connectorService",["data",function(a){return{findConnectingMatch:function(b,c){for(var d=parseInt(b.match.meta.matchId.split("-")[1]),e=parseInt(b.match.meta.matchId.split("-")[2]),f=0,g=0;e>g;g++)2!=a.getMatches()[d-1][g].meta.matchType&&(f+=1==a.getMatches()[d-1][g].meta.matchType||g+1==e?1:2);for(var h=null,i=c;null!==i.parent()&&i.parent().length>0;)if(i=i.parent(),"bracketRoot"===i.attr("id")){h=i;break}var j="match-"+(d-1)+"-"+f;return angular.element(document.getElementById(j))},findChildMatch:function(a){for(var b=angular.element(a).children(),c=0;c<b.length;c++)if(angular.element(b[c]).hasClass("match"))return angular.element(b[c])}}}]),myApp.factory("positioningService",function(){var a=function(a){var b=document.getElementsByClassName("roundHeader")[0],d=document.getElementsByClassName("round")[0];matchEl=document.createElement("div"),matchEl.style.visibility="hidden",matchEl.className="match",d.appendChild(matchEl),document.all?(a.matchHeight=matchEl.currentStyle.height,a.matchWidth=matchEl.currentStyle.width,a.matchMarginH=parseInt(matchEl.currentStyle.marginRight),a.matchMarginV=parseInt(matchEl.currentStyle.marginTop)+parseInt(matchEl.currentStyle.marginBottom),a.borderThickness=parseInt(matchEl.currentStyle.borderWidth),a.roundMarginTop=b.currentStyle.height+parseInt(b.currentStyle.marginTop)+parseInt(b.currentStyle.marginBottom)):(a.matchHeight=parseInt(document.defaultView.getComputedStyle(matchEl,"").getPropertyValue("height").replace("px","")),a.matchWidth=parseInt(document.defaultView.getComputedStyle(matchEl,"").getPropertyValue("width").replace("px","")),a.matchMarginH=parseInt(document.defaultView.getComputedStyle(matchEl,"").getPropertyValue("margin-right").replace("px","")),a.matchMarginV=parseInt(document.defaultView.getComputedStyle(matchEl,"").getPropertyValue("margin-top"))+parseInt(document.defaultView.getComputedStyle(matchEl,"").getPropertyValue("margin-bottom")),a.borderThickness=parseInt(document.defaultView.getComputedStyle(matchEl,"").getPropertyValue("border-right-width")),a.roundMarginTop=parseInt(document.defaultView.getComputedStyle(b,"").getPropertyValue("height").replace("px",""))+parseInt(document.defaultView.getComputedStyle(b,"").getPropertyValue("margin-top"))+parseInt(document.defaultView.getComputedStyle(b,"").getPropertyValue("margin-bottom"))),d.removeChild(matchEl),c=!0},b={matchHeight:null,matchWidth:null,matchMarginH:null,matchMarginV:null,borderThickness:null,roundMarginTop:null},c=!1;return{getBracketProperties:function(){return c||a(b),JSON.parse(JSON.stringify(b))}}});var myApp=angular.module("ngBracket");myApp.directive("doFocus",function(){return{restrict:"A",link:function(a,b){b&&(b[0].focus(),b[0].select())}}}),myApp.directive("score",["data",function(a){return{restrict:"E",scope:{team:"=",match:"=",results:"="},template:'<div class="score" ng-click="editScore(team)" ng-init="status=\'uneditable\'" ng-switch="status"><input class="score" ng-switch-when="editable" ng-blur="endEditScore(team)" do-focus="" type="number" ng-model="team.score" ng-pattern="/^[0-9]+$/"></input><span ng-class="{score:true, empty: (!team.id || 0 === team.id.length)}" ng-switch-when="uneditable">{{ team.score }}</span></div>',link:function(b){b.editScore=function(){b.match.team1.id&&b.match.team2.id&&(b.status="editable")},b.calculateResults=function(c){if("undefined"==typeof b.match.team1.score||""===b.match.team1.score||"undefined"==typeof b.match.team2.score||""===b.match.team2.score||b.match.team1.score===b.match.team2.score)return b.results.winner="",void(b.results.loser="");var d;b.match.team1.score>b.match.team2.score?(d=b.match.team1.id,b.results.loser=b.match.team2.id):(d=b.match.team2.id,b.results.loser=b.match.team1.id),b.results.winner=d,a.updateTournament(b.match,d,c)},b.endEditScore=function(){b.status="uneditable",b.calculateResults(null)},b.$watch("match.team1.id",function(a,c){a&&b.calculateResults(c)},!0),b.$watch("match.team2.id",function(a,c){a&&b.calculateResults(c)},!0)},replace:!0}}]),myApp.directive("match",["connectorService","positioningService","data","$filter","highlight",function(a,b,c,d,e){return{restrict:"E",scope:!1,template:'<div class="match" ng-init="results={winner:\'\', loser:\'\'}" ng-class="{tbd:((!team1Details.id || 0 === team1Details.id.length) && (!team2Details.id || 0 === team2Details.id.length))}"><div class="team" ng-mouseenter="highlightTrack(team1Details.id)" ng-mouseleave="highlightTrack()" ng-class="{empty: (!team1Details.id || 0 === team1Details.id.length), separator: (team1Details.id.length > 0 && team2Details.id.length > 0), highlight: highlight.teamId === team1Details.id, loser: results.loser.length > 0 && results.loser == team1Details.id, winner: results.winner.length > 0 && results.winner == team1Details.id}"><div class="flagContainer"><div class="flag" style="background-image:url(images/{{team1Details.flag}}.png)"></div></div><span>{{ team1Details.name }}</span><score team="match.team1" match="match" results="results"></score></div><div class="team" ng-mouseenter="highlightTrack(team2Details.id)" ng-mouseleave="highlightTrack()" ng-class="{empty: (!team2Details.id || 0 === team2Details.id.length), highlight: highlight.teamId === team2Details.id, loser: results.loser.length > 0 && results.loser == team2Details.id, winner: results.winner.length > 0 && results.winner == team2Details.id}"><div class="flagContainer"><div class="flag" style="background-image:url(images/{{team2Details.flag}}.png)"></div></div><span>{{ team2Details.name }}</span><score team="match.team2" match="match" results="results"></score></div></div>',replace:!0,link:function(f,g){f.getTeamDetails=function(a){return d("getById")(c.getParticipants(),a)},f.highlightTrack=function(a){e.setHighlight(a)},f.team1Details=f.getTeamDetails(f.match.team1.id),f.team2Details=f.getTeamDetails(f.match.team2.id),f.$watch("match.team1",function(a){a&&(f.team1Details=f.getTeamDetails(f.match.team1.id))},!0),f.$watch("match.team2",function(a){a&&(f.team2Details=f.getTeamDetails(f.match.team2.id))},!0);var h=parseInt(f.match.meta.matchId.split("-")[1]),i=parseInt(f.match.meta.matchId.split("-")[2]),j=b.getBracketProperties();g.css("left",j.matchMarginH/2+"px");var k=0;if(1===h){var l=f.match.meta.UIShiftDown?parseInt(f.match.meta.UIShiftDown):0;k=(j.matchHeight+j.matchMarginV)*(i-1+l)+j.roundMarginTop}else if(2==f.match.meta.matchType)k=(j.matchHeight+j.matchMarginV)*(i-1)+j.roundMarginTop;else{var m=a.findConnectingMatch(f,g);if(k=angular.element(m[0].firstElementChild).prop("offsetTop"),1!=f.match.meta.matchType){var n=parseInt(m.scope().match.meta.matchId.split("-")[2]),o=angular.element(document.getElementById("match-"+(h-1)+"-"+(n+1))),p=angular.element(o[0].firstElementChild).prop("offsetTop")+j.matchHeight;k=k+(p-k)/2-j.matchHeight/2}}g.css("top",k+"px")}}}]),myApp.directive("connectors",["connectorService","positioningService","$compile",function(a,b,c){return{restrict:"E",template:'<div class="connectors"></div>',replace:!0,scope:!1,link:function(d,e){function f(a,b,e,f,g){var h=null===g?"cMatch1":"cMatch"+g.toString(),i=null===g?"":1==g?"tbdB:match.team1.id.length == 0":"tbdB:match.team2.id.length == 0",j="highlight: highlight.teamId !== null && ((match.team1.id === highlight.teamId || match.team2.id === highlight.teamId) && ("+h+".team1.id === highlight.teamId || "+h+".team2.id === highlight.teamId))",k='ng-class="{'+i+(i.length>0?", ":"")+j+'}"';return angular.element(c('<div class="connector" style="left:'+e+"px;top:"+f+"px;width:"+a+"px;height:"+b+'px" '+k+"></div>")(d))}if(2!=d.match.meta.matchType){var g=parseInt(d.match.meta.matchId.split("-")[1]);if(g>1){var h=b.getBracketProperties(),i=a.findChildMatch(e.parent()),j=angular.element(a.findConnectingMatch(d,e)[0].firstElementChild);d.cMatch1=j.scope().match;var k=i.prop("offsetLeft"),l=i.prop("offsetTop")+h.matchHeight/2;if(1==d.match.meta.matchType)return void e.append(f(h.matchMarginH-h.borderThickness,1,k-h.matchMarginH+h.borderThickness,l,null).addClass("connectorBottom"));var m=h.matchMarginH/2,n=l-j.prop("offsetTop")-h.matchHeight/2,o=k-m-h.borderThickness,p=l-n,q=f(m,n,o,p,1).addClass("connectorBottom connectorLeft");e.append(q),m=h.matchMarginH/2-h.borderThickness,o=o-m+h.borderThickness,e.append(f(m,1,o,p,1).addClass("connectorTop"));var r=j.scope().match.meta.matchId.split("-"),s=r[0]+"-"+r[1]+"-"+(parseInt(r[2])+1),t=angular.element(a.findChildMatch(document.getElementById(s)));d.cMatch2=t.scope().match,m=h.matchMarginH/2,n=t.prop("offsetTop")+h.matchHeight/2-l,o=k-m-h.borderThickness,p=l,e.append(f(m,n,o,p,2).addClass("connectorTop connectorLeft")),m=h.matchMarginH/2-h.borderThickness,o=o-m+h.borderThickness,p=l+n,e.append(f(m,1,o,p,2).addClass("connectorTop"))}}}}}]),angular.module("ngBracket").controller("bracketController",["$scope","$window","positioningService","data","highlight",function(a,b,c,d,e){a.participants=[],a.tournamentData={type:"SE",matches:[]},a.highlight=e.mapHighlight(),a.calculateRoundHeight=function(){var b=0;if(a.tournamentData.matches.length>0){var d=c.getBracketProperties(),e=a.tournamentData.matches[0].length>a.tournamentData.matches[1].length?a.tournamentData.matches[0].length:a.tournamentData.matches[1].length;b=e*(d.matchHeight+d.matchMarginV)+d.roundMarginTop}return b},a.calculateRoundWidth=function(){var b=0;if(a.tournamentData.matches.length>0){var d=c.getBracketProperties();b=a.tournamentData.matches.length*(d.matchWidth+d.matchMarginH)+40}return b},a.addPlayer=function(){a.newPlayerName&&a.participants.push({name:a.newPlayerName,id:(a.participants.length+1).toString(),flag:"countries/"+a.newPlayerFlag,members:[]})},a.loadTournament=function(){a.tournamentData=d.loadTournament(),a.participants=d.getParticipants()},a.newTournament=function(){function b(a,b,c){function d(a,b){null!==a&&null!==b&&(a.id=b.id)}function e(a,b){return{team1:{id:"",score:""},team2:{id:"",score:""},meta:{matchId:"match-"+a+"-"+b},details:{}}}function f(a,b,c){var d,e=[],f=0,g=0,h=0,i=0,j=0;for(d=0;a>d;d++)e[d]=c?1:0;for(d=c?a:0;b>d;d++){var k=0;f%2===0?a/4>g?(k=2*g+1,g+=1):(k=2*h,h+=1):a/4>i?(k=a/2+2*i+1,i+=1):(k=a/2+2*j,j+=1),e[k]+=1,f+=1}return e}function g(a,b){var c,d=0;for(c=0;c<a.length;c++)2!=a[c].meta.matchType&&(d+=1==a[c].meta.matchType?1:2);for(c=d;c<b.length;c++)b[c].meta.UIShiftDown=b[c].meta.UIShiftDown?b[c].meta.UIShiftDown+1:1}var h,i,j=[],k=1,l=null,m=0;if(1===b){for(;2*k<a.length;)k*=2;var n=a.length-k;if(n>0){m=n-k/2;var o=0===m?k:m>0?k+2*m:k-2*Math.abs(m);l=a.slice(o,a.length),a.splice(o,a.length)}}for(h=0;h<a.length;h++){if(i=e(b,j.length+1),1===b){if(h%2!==0)continue;d(i.team1,a[h]),d(i.team2,a[h+1])}else if(h%2!==0)continue;j.push(i)}var p;if(1===b&&null!==l&&l.length>0){c.matches.push(j.slice());var q=[];if(0===m)for(h=0;h<l.length;h++)i=e(b+1,q.length+1),d(i.team1,l[h]),i.meta.matchType=1,q.push(i);else if(m>0){p=f(k/2,l.length,!1);var r=0;for(h=0;h<p.length;h++)i=e(b+1,q.length+1),1===p[h]&&(d(i.team1,l[r]),i.meta.matchType=1,r+=1),q.push(i)}else if(0>m){p=f(k/2,l.length,!0);var s=0;for(h=0;k/2>h;h++)i=e(b+1,q.length+1),d(i.team1,l[s]),i.meta.matchType=1,2===p[h]&&(d(i.team2,l[s+1]),i.meta.matchType=2,g(q,j),s+=1),s+=1,q.push(i)}return a=null,q}return a=null,j}if(!(a.participants.length<3)){d.setParticipants(a.participants.slice());for(var c=[],e=1;1==e||Math.floor(c.length)>1;){var f=c;1==e&&(f=a.participants.slice()),c=b(f,e,a.tournamentData),a.tournamentData.matches.push(c.slice()),e=a.tournamentData.matches.length+1}d.setTournament(a.tournamentData)}}}]);