/*! ngBracket 04-06-2014 */
function findParentByAttribute(a,b,c){if(null===a||null===b||null===c)return null;for(var d=null,e=angular.element(a);null!==e.parent()&&e.parent().length>0;)if(e=e.parent(),e.attr(b)===c){d=e;break}return d}var myApp=angular.module("ngBracket",[]);myApp.filter("iif",function(){return function(a,b,c){return a?b:c}}),myApp.filter("getById",function(){return function(a,b){for(var c=0;c<a.length;c++)if(a[c].id==b)return a[c];return null}}),myApp.factory("highlight",function(){var a={teamId:null};return{mapHighlight:function(){return a},setHighlight:function(b){a.teamId=b&&b.length>0?b:null}}}),myApp.factory("data",["$rootScope",function(){var a={},b={};return{getParticipants:function(){return a},getMatches:function(){return b.matches},setParticipants:function(b){a=b},setTournament:function(a){b=a},updateTournament:function(a,c,d){function e(a,b,c,d){-1!==c.indexOf(a.team1.id)?a.team1.id=b:-1!==c.indexOf(a.team2.id)?a.team2.id=b:!(d||l>h)||a.team1.id&&0!==a.team1.id.length?a.team2.id=b:a.team1.id=b}var f=a.meta.matchId.split("-"),g=parseInt(f[1]),h=parseInt(f[2]);if(g!==b.matches.length){var i=[a.team1.id,a.team2.id];if(null!==d&&d.length>0&&i.push(d),g===b.matches.length-1&&2===b.matches[b.matches.length-1].length){var j=a.team1.id===c?a.team2.id:a.team1.id,k=b.matches[b.matches.length-1][1];e(k,j,i,1===h)}for(var l=0,m=b.matches[g],n=0;n<m.length;n++)if(2!=m[n].meta.matchType&&(l+=1==m[n].meta.matchType?1:2,l>=h)){e(m[n],c,i);break}}},loadTournament:function(){var a=JSON.parse('[{"name":"Austria","id":"1","flag":"countries/aut","members":["Player1", "Player2", "Player3", "Player4", "Player5"]},{"name":"Czech","id":"2","flag":"countries/cze","members":["Player1", "Player2", "Player3", "Player4", "Player5"]},{"name":"France","id":"3","flag":"countries/fra","members":["Player1", "Player2", "Player3", "Player4", "Player5"]},{"name":"Switzerland","id":"4","flag":"countries/sui","members":["Player1", "Player2", "Player3", "Player4", "Player5"]},{"name":"United States","id":"5","flag":"countries/usa","members":["Player1", "Player21", "Player3", "Player4", "Player5"]},{"name":"Sweden","id":"6","flag":"countries/swe","members":["Player1", "Player2", "Player3", "Player4", "Player5"]},{"name":"Finland","id":"7","flag":"countries/fin","members":["Player1", "Player2", "Player3", "Player4", "Player5"]},{"name":"Germany","id":"8","flag":"countries/ger","members":["Player1", "Player2", "Player3", "Player4", "Player5"]},{"name":"Russia","id":"9","flag":"countries/rus","members":["Player1", "Player2", "Player3", "Player4", "Player5"]},{"name":"Canada","id":"10","flag":"countries/can","members":["Player1", "Player2", "Player3", "Player4", "Player5"]},{"name":"United Kingdom","id":"11","flag":"countries/uk","members":["Player1", "Player2", "Player3", "Player4", "Player5"]},{"name":"China","id":"12","flag":"countries/chi","members":["Player1", "Player2", "Player3", "Player4", "Player5"]},{"name":"Denmark","id":"13","flag":"countries/den","members":["Player1", "Player2", "Player3", "Player4", "Player5"]}]'),b=JSON.parse('{"type":"SE","matches":[[{"team1":{"id":"1","score":""},"team2":{"id":"2","score":""},"meta":{"matchId":"match-1-1"},"details":{}},{"team1":{"id":"3","score":4},"team2":{"id":"4","score":2},"meta":{"matchId":"match-1-2"},"details":{}},{"team1":{"id":"5","score":""},"team2":{"id":"6","score":""},"meta":{"matchId":"match-1-3"},"details":{}},{"team1":{"id":"7","score":""},"team2":{"id":"8","score":""},"meta":{"matchId":"match-1-4"},"details":{}},{"team1":{"id":"9","score":3},"team2":{"id":"10","score":4},"meta":{"matchId":"match-1-5"},"details":{}}],[{"team1":{"id":"11","score":""},"team2":{"id":"","score":""},"meta":{"matchId":"match-2-1","matchType":1},"details":{}},{"team1":{"id":"12","score":""},"team2":{"id":"3","score":""},"meta":{"matchId":"match-2-2","matchType":1},"details":{}},{"team1":{"id":"","score":""},"team2":{"id":"","score":""},"meta":{"matchId":"match-2-3"},"details":{}},{"team1":{"id":"13","score":0},"team2":{"id":"10","score":2},"meta":{"matchId":"match-2-4","matchType":1},"details":{}}],[{"team1":{"id":"","score":""},"team2":{"id":"","score":""},"meta":{"matchId":"match-3-1"},"details":{}},{"team1":{"id":"","score":""},"team2":{"id":"10","score":""},"meta":{"matchId":"match-3-2"},"details":{}}],[{"team1":{"id":"","score":""},"team2":{"id":"","score":""},"meta":{"matchId":"match-4-1"},"details":{}}]]}');return this.setParticipants(a),this.setTournament(b),b}}}]),myApp.factory("connectorService",["data",function(a){return{findConnectingMatch:function(b){for(var c=parseInt(b.match.meta.matchId.split("-")[1]),d=parseInt(b.match.meta.matchId.split("-")[2]),e=0,f=0;d>f;f++)2!=a.getMatches()[c-1][f].meta.matchType&&(e+=1==a.getMatches()[c-1][f].meta.matchType||f+1==d?1:2);var g="match-"+(c-1)+"-"+e;return angular.element(document.getElementById(g))},findChildMatch:function(a){for(var b=angular.element(a).children(),c=0;c<b.length;c++)if(angular.element(b[c]).hasClass("match"))return angular.element(b[c])}}}]),myApp.factory("positioningService",function(){var a=function(a){var b=document.getElementsByClassName("roundHeader")[0],d=document.getElementsByClassName("round")[0];matchEl=document.createElement("div"),matchEl.style.visibility="hidden",matchEl.className="match",d.appendChild(matchEl),document.all?(a.matchHeight=matchEl.currentStyle.height,a.matchWidth=matchEl.currentStyle.width,a.matchMarginH=parseInt(matchEl.currentStyle.marginRight),a.matchMarginV=parseInt(matchEl.currentStyle.marginTop)+parseInt(matchEl.currentStyle.marginBottom),a.borderThickness=parseInt(matchEl.currentStyle.borderWidth),a.roundMarginTop=b.currentStyle.height+parseInt(b.currentStyle.marginTop)+parseInt(b.currentStyle.marginBottom)):(a.matchHeight=parseInt(document.defaultView.getComputedStyle(matchEl,"").getPropertyValue("height").replace("px","")),a.matchWidth=parseInt(document.defaultView.getComputedStyle(matchEl,"").getPropertyValue("width").replace("px","")),a.matchMarginH=parseInt(document.defaultView.getComputedStyle(matchEl,"").getPropertyValue("margin-right").replace("px","")),a.matchMarginV=parseInt(document.defaultView.getComputedStyle(matchEl,"").getPropertyValue("margin-top"))+parseInt(document.defaultView.getComputedStyle(matchEl,"").getPropertyValue("margin-bottom")),a.borderThickness=parseInt(document.defaultView.getComputedStyle(matchEl,"").getPropertyValue("border-right-width")),a.roundMarginTop=parseInt(document.defaultView.getComputedStyle(b,"").getPropertyValue("height").replace("px",""))+parseInt(document.defaultView.getComputedStyle(b,"").getPropertyValue("margin-top"))+parseInt(document.defaultView.getComputedStyle(b,"").getPropertyValue("margin-bottom"))),d.removeChild(matchEl),c=!0},b={matchHeight:null,matchWidth:null,matchMarginH:null,matchMarginV:null,borderThickness:null,roundMarginTop:null},c=!1;return{getBracketProperties:function(){return c||a(b),JSON.parse(JSON.stringify(b))}}}),myApp.factory("matchDetailService",function(){var a=null,b={},c="",d=!1,e=!0;return{setEnabled:function(a){e=a},mapMatchDetails:function(){return b},showDetails:function(f,g){if(e){if(null!==a&&"visible"==a.css("visibility")&&g.matchId==c)return void this.hideDetails();if(c=g.matchId,b.team1Details=g.team1Details,b.team2Details=g.team2Details,b.results=g.results,d||(a=angular.element(document.getElementById("detailOverlay")),d=!0),null!==a&&null!==f){var h=findParentByAttribute(f,"class","match")[0];if(null!==h&&h.getBoundingClientRect()){var i=h.getBoundingClientRect(),j=i.right+(void 0!==window.pageXOffset?window.pageXOffset:(document.documentElement||document.body.parentNode||document.body).scrollLeft),k=i.top+(void 0!==window.pageYOffset?window.pageYOffset:(document.documentElement||document.body.parentNode||document.body).scrollTop);a.css("left",j+"px"),a.css("top",k-20+"px"),a.css("visibility","visible")}}}},hideDetails:function(){null!==a&&a.css("visibility","hidden")}}});var myApp=angular.module("ngBracket");myApp.directive("doFocus",function(){return{restrict:"A",link:function(a,b){b&&(b[0].focus(),b[0].select())}}}),myApp.directive("score",["data",function(a){return{restrict:"E",scope:{team:"=",match:"=",results:"="},template:'<div class="score" ng-click="editScore(team)" ng-init="status=\'uneditable\'" ng-switch="status"><input class="score" ng-switch-when="editable" ng-blur="endEditScore(team)" do-focus="" type="number" ng-model="team.score" ng-pattern="/^[0-9]+$/"></input><span ng-class="{score:true, empty: (!team.id || 0 === team.id.length)}" ng-switch-when="uneditable">{{ team.score }}</span></div>',link:function(b){b.editScore=function(){b.match.team1.id&&b.match.team2.id&&(b.status="editable")},b.calculateResults=function(c){if("undefined"==typeof b.match.team1.score||""===b.match.team1.score||"undefined"==typeof b.match.team2.score||""===b.match.team2.score||b.match.team1.score===b.match.team2.score)return b.results.winner="",void(b.results.loser="");var d;b.match.team1.score>b.match.team2.score?(d=b.match.team1.id,b.results.loser=b.match.team2.id):(d=b.match.team2.id,b.results.loser=b.match.team1.id),b.results.winner=d,a.updateTournament(b.match,d,c)},b.endEditScore=function(){b.status="uneditable",b.calculateResults(null)},b.$watch("match.team1.id",function(a,c){a&&b.calculateResults(c)},!0),b.$watch("match.team2.id",function(a,c){a&&b.calculateResults(c)},!0)},replace:!0}}]),myApp.directive("match",["connectorService","positioningService","data","$filter","highlight","matchDetailService",function(a,b,c,d,e,f){return{restrict:"E",scope:!1,template:'<div class="match" ng-init="results={winner:\'\', loser:\'\'}" ng-class="{tbd:((!team1Details.id || 0 === team1Details.id.length) && (!team2Details.id || 0 === team2Details.id.length))}" ng-click="showDetails($event)"><div class="team" ng-mouseenter="highlightTrack(team1Details.id)" ng-mouseleave="highlightTrack()" ng-class="{empty: (!team1Details.id || 0 === team1Details.id.length), separator: (team1Details.id.length > 0 && team2Details.id.length > 0), highlight: highlight.teamId === team1Details.id, loser: results.loser.length > 0 && results.loser == team1Details.id, winner: results.winner.length > 0 && results.winner == team1Details.id}"><div class="flagContainer"><div class="flag" style="background-image:url(images/{{team1Details.flag}}.png)"></div></div><span>{{ team1Details.name }}</span><score team="match.team1" match="match" results="results"></score></div><div class="team" ng-mouseenter="highlightTrack(team2Details.id)" ng-mouseleave="highlightTrack()" ng-class="{empty: (!team2Details.id || 0 === team2Details.id.length), highlight: highlight.teamId === team2Details.id, loser: results.loser.length > 0 && results.loser == team2Details.id, winner: results.winner.length > 0 && results.winner == team2Details.id}"><div class="flagContainer"><div class="flag" style="background-image:url(images/{{team2Details.flag}}.png)"></div></div><span>{{ team2Details.name }}</span><score team="match.team2" match="match" results="results"></score></div></div>',replace:!0,link:function(g,h){g.getTeamDetails=function(a){return d("getById")(c.getParticipants(),a)},g.highlightTrack=function(a){e.setHighlight(a)},g.showDetails=function(a){null!==g.team1Details&&null!==g.team2Details&&a.target&&!angular.element(a.target).hasClass("score")&&f.showDetails(a.target,{matchId:g.match.meta.matchId,team1Details:g.team1Details,team2Details:g.team2Details,results:g.match})},g.team1Details=g.getTeamDetails(g.match.team1.id),g.team2Details=g.getTeamDetails(g.match.team2.id),g.$watch("match.team1",function(a){a&&(g.team1Details=g.getTeamDetails(g.match.team1.id))},!0),g.$watch("match.team2",function(a){a&&(g.team2Details=g.getTeamDetails(g.match.team2.id))},!0);var i=parseInt(g.match.meta.matchId.split("-")[1]),j=parseInt(g.match.meta.matchId.split("-")[2]),k=b.getBracketProperties();h.prop("id","match-"+i+"-"+j),"finals"==g.match.meta.matchType&&(g.finals=!0),h.css("left",k.matchMarginH/2+"px");var l=0;if(1===i){var m=g.match.meta.UIShiftDown?parseInt(g.match.meta.UIShiftDown):0;l=(k.matchHeight+k.matchMarginV)*(j-1+m)+k.roundMarginTop}else if(2==g.match.meta.matchType)l=(k.matchHeight+k.matchMarginV)*(j-1)+k.roundMarginTop;else if("bronze"==g.match.meta.matchType){g.bronzeMatch=!0;var n=angular.element(document.getElementById("match-"+i+"-1"));l=n.prop("offsetTop")+k.matchHeight+40}else{var o=a.findConnectingMatch(g,h);if(l=angular.element(o[0].firstElementChild).prop("offsetTop"),1!=g.match.meta.matchType){var p=parseInt(o.scope().match.meta.matchId.split("-")[2]),q=angular.element(document.getElementById("match-"+(i-1)+"-"+(p+1))),r=angular.element(q[0].firstElementChild).prop("offsetTop")+k.matchHeight;l=l+(r-l)/2-k.matchHeight/2}}h.css("top",l+"px")}}}]),myApp.directive("connectors",["connectorService","positioningService","$compile",function(a,b,c){return{restrict:"E",template:'<div class="connectors"></div>',replace:!0,scope:!1,link:function(d,e){function f(a,b,e,f,g){var h=null===g?"cMatch1":"cMatch"+g.toString(),i=null===g?"":1==g?"tbdB:match.team1.id.length == 0":"tbdB:match.team2.id.length == 0",j="highlight: highlight.teamId !== null && ((match.team1.id === highlight.teamId || match.team2.id === highlight.teamId) && ("+h+".team1.id === highlight.teamId || "+h+".team2.id === highlight.teamId))",k='ng-class="{'+i+(i.length>0?", ":"")+j+'}"';return angular.element(c('<div class="connector" style="left:'+e+"px;top:"+f+"px;width:"+a+"px;height:"+b+'px" '+k+"></div>")(d))}if(2!=d.match.meta.matchType&&"bronze"!=d.match.meta.matchType){var g=parseInt(d.match.meta.matchId.split("-")[1]);if(g>1){var h=b.getBracketProperties(),i=a.findChildMatch(e.parent()),j=angular.element(a.findConnectingMatch(d,e)[0].firstElementChild);d.cMatch1=j.scope().match;var k=i.prop("offsetLeft"),l=i.prop("offsetTop")+h.matchHeight/2;if(1==d.match.meta.matchType)return void e.append(f(h.matchMarginH-h.borderThickness,1,k-h.matchMarginH+h.borderThickness,l,null).addClass("connectorBottom"));var m=h.matchMarginH/2,n=l-j.prop("offsetTop")-h.matchHeight/2,o=k-m-h.borderThickness,p=l-n,q=f(m,n,o,p,1).addClass("connectorBottom connectorLeft");e.append(q),m=h.matchMarginH/2-h.borderThickness,o=o-m+h.borderThickness,e.append(f(m,1,o,p,1).addClass("connectorTop"));var r=j.scope().match.meta.matchId.split("-"),s=r[0]+"-"+r[1]+"-"+(parseInt(r[2])+1),t=angular.element(a.findChildMatch(document.getElementById(s)));d.cMatch2=t.scope().match,m=h.matchMarginH/2,n=t.prop("offsetTop")+h.matchHeight/2-l,o=k-m-h.borderThickness,p=l,e.append(f(m,n,o,p,2).addClass("connectorTop connectorLeft")),m=h.matchMarginH/2-h.borderThickness,o=o-m+h.borderThickness,p=l+n,e.append(f(m,1,o,p,2).addClass("connectorTop"))}}}}}]),angular.module("ngBracket").controller("bracketController",["$scope","$window","positioningService","data","highlight","matchDetailService",function(a,b,c,d,e,f){a.participants=[],a.tournamentData={type:"SE",matches:[]},a.highlight=e.mapHighlight(),a.matchToShow=f.mapMatchDetails(),a.calculateRoundHeight=function(){var b=0;if(a.tournamentData.matches.length>0){var d=c.getBracketProperties(),e=a.tournamentData.matches[0].length>a.tournamentData.matches[1].length?a.tournamentData.matches[0].length:a.tournamentData.matches[1].length;b=e*(d.matchHeight+d.matchMarginV)+d.roundMarginTop}return b},a.calculateRoundWidth=function(){var b=0;if(a.tournamentData.matches.length>0){var d=c.getBracketProperties();b=a.tournamentData.matches.length*(d.matchWidth+d.matchMarginH)+40}return b},a.addPlayer=function(){a.newPlayerName&&a.participants.push({name:a.newPlayerName,id:(a.participants.length+1).toString(),flag:"countries/"+a.newPlayerFlag,members:[]})},a.generateWithRandomPlayers=function(){if(a.playersToGenerate){a.participants=[],a.tournamentData={type:"SE",matches:[]};var b=parseInt(a.playersToGenerate);if(b>3){for(var c=1;b>=c;c++)a.participants.push({name:"Player"+c,id:c.toString(),flag:"",members:[]});a.newTournament()}}},a.loadTournament=function(){a.tournamentData=d.loadTournament(),a.participants=d.getParticipants()},a.showDetails=function(){f.hideDetails(),f.setEnabled(a.enableDetails)},a.newTournament=function(){function b(a,b){return{team1:{id:"",score:""},team2:{id:"",score:""},meta:{matchId:"match-"+a+"-"+b},details:{}}}function c(a,c,d){function e(a,b,c){var d,e,f,g=[],h=c?Math.floor(2*a-b):b;for(d=0;a>d;d++)g[d]=c?2:0;var i=a%h===0?a/h:2;for(d=0;h>d;d++){e=!1,f=0;var j=0===d?0:d%2===0?Math.max((d/2-1)*i,0):a/2+Math.max((Math.floor(d/2)-1)*i,0);if(d>1&&(j+=i),j>a-1&&(e=!0,f=a/2-1),1===g[j]||e)for(var k=f;a>k;k++)if(1!==g[k]){j=k;break}g[j]=c?g[j]-1:g[j]+1}return g}function f(a,b){var c,d=0;for(c=0;c<a.length;c++)2!=a[c].meta.matchType&&(d+=1==a[c].meta.matchType?1:2);for(c=d;c<b.length;c++)b[c].meta.UIShiftDown=b[c].meta.UIShiftDown?b[c].meta.UIShiftDown+1:1}var g,h,i=[],j=1,k=null,l=0;if(1===c){for(;2*j<a.length;)j*=2;var m=a.length-j;if(m>0){l=m-j/2;var n=0===l?j:l>0?j+2*l:j-2*Math.abs(l);k=a.slice(n,a.length),a.splice(n,a.length)}}for(g=0;g<a.length;g++){if(h=b(c,i.length+1),1===c){if(g%2!==0)continue;h.team1.id=a[g].id,h.team2.id=a[g+1].id}else if(g%2!==0)continue;i.push(h)}var o;if(1===c&&null!==k&&k.length>0){d.matches.push(i.slice());var p=[];if(0===l)for(g=0;g<k.length;g++)h=b(c+1,p.length+1),h.team1.id=k[g].id,h.meta.matchType=1,p.push(h);else if(l>0){o=e(j/2,k.length,!1);var q=0;for(g=0;g<o.length;g++)h=b(c+1,p.length+1),1===o[g]&&(h.team1.id=k[q].id,h.meta.matchType=1,q+=1),p.push(h)}else if(0>l){o=e(j/2,k.length,!0);var r=0;for(g=0;j/2>g;g++)h=b(c+1,p.length+1),h.team1.id=k[r].id,h.meta.matchType=1,2===o[g]&&(h.team2.id=k[r+1].id,h.meta.matchType=2,f(p,i),r+=1),r+=1,p.push(h)}return a=null,p}return a=null,i}if(!(a.participants.length<3)){d.setParticipants(a.participants.slice());for(var e=[],f=1;1==f||Math.floor(e.length)>1;){var g=e;1==f&&(g=a.participants.slice()),e=c(g,f,a.tournamentData),a.tournamentData.matches.push(e.slice()),f=a.tournamentData.matches.length+1}if(a.tournamentData.matches[a.tournamentData.matches.length-1][0].meta.matchType="finals",a.playBronzeMatch){var h=b(a.tournamentData.matches.length,2);h.meta.matchType="bronze",a.tournamentData.matches[a.tournamentData.matches.length-1].push(h)}d.setTournament(a.tournamentData)}}}]);