/*! ngBracket 15-01-2015 */
var app=angular.module("ngBracket",[]);app.findParentByAttribute=function(a,b,c){if(null===a||null===b||null===c)return null;for(var d=null,e=angular.element(a);null!==e.parent()&&e.parent().length>0;)if(e=e.parent(),e.attr(b)===c){d=e;break}return d},app.filter("iif",function(){return function(a,b,c){return a?b:c}}),app.filter("getById",function(){return function(a,b){for(var c=0;c<a.length;c++)if(a[c].id==b)return a[c];return null}}),app.filter("reverse",function(){return function(a,b){return 2===b?a.slice().reverse():a}}),app.findFirstRound=function(a){for(var b=0;b<a.length;b++)if("L"!==a[b][0].meta.matchId.slice(-1))return b;return null},app.factory("data",function(){var a=null;return{getTeams:function(b){var c=b?b-1:null;return b?a.teams[c]:1===a.teams.length?a.teams[0]:a.teams},getMatches:function(b){return"C1"===b?a.tournament.conferences[0].matches:"C2"===b?a.tournament.conferences[2].matches:"F"===b?a.tournament.conferences[1].matches:a.tournament.conferences},getTournamentType:function(){return a.tournament.type},isDoubleConference:function(){return a.tournament.doubleConference},getProperties:function(){return a.tournament.properties},getOptions:function(){return a.options},updateTournament:function(b,c,d,e,f){function g(a,b,c,d){null!==a&&(-1!==c.indexOf(a.team1.id)?a.team1.id=b:-1!==c.indexOf(a.team2.id)?a.team2.id=b:!(d||y>q)||a.team1.id&&0!==a.team1.id.length?a.team2.id=b:a.team1.id=b)}function h(a,b){for(var c=0;c<o[b].length;c++)if(o[b][c].meta.matchType==a)return o[b][c];return null}function i(a,b){void 0!==b?(b.indexOf(a.team1.id)>-1&&(v.team1.id="",v.team1.score=""),b.indexOf(a.team2.id)>-1&&(v.team2.id="",v.team2.score="")):(v.team1.id="",v.team2.id="",v.team1.score="",v.team2.score="")}"Not started"===a.tournament.properties.status&&(a.tournament.properties.status="In progress");var j,k,l,m,n=b.meta.matchId.split("-"),o="C2"==n[1]?a.tournament.conferences[2].matches:a.tournament.conferences[0].matches,p=parseInt(n[2]),q=parseInt(n[3]),r="L"===n[n.length-1],s=p===o.length-1,t=[b.team1.id,b.team2.id];if("F"!==n[1]){if(null!==e&&e.length>0&&t.push(e),"DE"===a.tournament.type&&"finals"===b.meta.matchType){var u=o.length-2;l=o[u].length-1,k=o[u][l].team1.score>o[u][l].team2.score?o[u][l].team1.id:o[u][l].team2.id,"C1"===n[1]?a.tournament.properties.finals2C1=m=d!=k:"C2"===n[1]&&(a.tournament.properties.finals2C2=m=d!=k);var v=h("finals2",o.length-1);if(d!=k?(null!==v&&(v.team1.id=b.team1.id,v.team2.id=b.team2.id),a.tournament.doubleConference&&(v=a.tournament.conferences[1].matches[0][0],i(v,t),a.tournament.conferences[1].matches[0].length>1&&(v=a.tournament.conferences[1].matches[0][1],i(v,t)))):null!==v&&i(v),m)return}if("SE"===a.tournament.type&&p===o.length||"DE"===a.tournament.type&&("bronze"===b.meta.matchType||"finals2"===b.meta.matchType||m===!1)){if(a.tournament.doubleConference&&p===o.length){var w=a.tournament.conferences[1].matches[0];g(w[0],c,t,"C1"===n[1]),w.length>1&&g(w[1],d,t,"C1"===n[1])}}else{if("SE"===a.tournament.type&&s&&o[o.length-1].length>1||"DE"===a.tournament.type&&r&&(s||p===o.length-2)||a.tournament.doubleConference&&"DE"===a.tournament.type){l=o[o.length-1].length;var x=h("bronze",o.length-1);g(x,d,t,1===q)}var y=0,z=o[p],A=r&&s;for(j=0;j<z.length;j++)if(2!=z[j].meta.matchType){if(r&&"L"!==z[j].meta.matchId.slice(-1)&&!s)continue;if(y+=1==z[j].meta.matchType?1:2,y>=q){g(z[j],c,t,A);break}}if(f){var B=parseInt(b.meta.loserMatchId.split("-")[2])-1,C=o[B];for(j=C.length-1;j>=0;j--){if(C[j].meta.team1Parent===b.meta.matchId){C[j].team1.id=d;break}if(C[j].meta.team2Parent===b.meta.matchId){C[j].team2.id=d;break}}}}}},loadTournament:function(b){a=b}}}).factory("connectorService",["data",function(a){return{findConnectingMatchId:function(b){var c,d,e=b.meta.matchId.split("-"),f=parseInt(e[2]),g=parseInt(e[3]),h="L"===b.meta.matchId.slice(-1)?"-L":"",i=0,j=a.getMatches("F"===e[1]&&"finals"===b.meta.matchType?"C1":e[1]),k=0,l=a.getTournamentType();if(h.length>0)for(c=0;c<j[f-1].length;c++)if("L"===j[f-1][c].meta.matchId.slice(-1)){k=c;break}if("finals2"===b.meta.matchType)d="match-"+e[1]+"-"+f+"-1";else if("F"===e[1]){var m=j[j.length-1];d="DE"===l?m[1].meta.matchId:m[0].meta.matchId}else{for(c=0;g>c;c++)2!=j[f-1][c+k].meta.matchType&&(i+=1==j[f-1][c+k].meta.matchType||c+1==g?1:2);d="match-"+e[1]+"-"+(f-1)+"-"+i+h}return d},findConnectingMatch:function(a){return angular.element(document.getElementById(this.findConnectingMatchId(a)))},findChildMatch:function(a){for(var b=angular.element(a).children(),c=0;c<b.length;c++)if(angular.element(b[c]).hasClass("match"))return angular.element(b[c])},findConferenceFinals:function(){function b(b,c){var d=a.getMatches(b),e=d.length,f=d[e-1].length,g="DE"!==a.getTournamentType()||c?1:f;return"match-"+b+"-"+e+"-"+g}var c={C1:null,C2:null,C2_1:null},d=b("C1");return c.C1=angular.element(document.getElementById(d)).children()[0],a.isDoubleConference()&&(d=b("C2"),c.C2=angular.element(document.getElementById(d)).children()[0],"DE"===a.getTournamentType()&&(d=b("C2",!0),c.C2_1=angular.element(document.getElementById(d)).children()[0])),c}}}]).factory("highlight",function(){var a={teamId:null};return{mapHighlight:function(){return a},setHighlight:function(b){a.teamId=b&&b.length>0?b:null}}}).factory("layoutService",["data",function(a){function b(a){return"L"!==a.meta.matchId.slice(-1)}function c(a){return"L"===a.meta.matchId.slice(-1)}function d(a){var b=document.getElementsByClassName("roundHeader")[0],c=document.getElementsByClassName("round")[0];matchEl=document.createElement("div"),matchEl.style.visibility="hidden",matchEl.className="match",b&&c&&(c.appendChild(matchEl),document.all?(a.matchHeight=matchEl.currentStyle.height,a.matchWidth=matchEl.currentStyle.width,a.matchMarginH=parseInt(matchEl.currentStyle.marginRight),a.matchMarginV=parseInt(matchEl.currentStyle.marginTop)+parseInt(matchEl.currentStyle.marginBottom),a.borderThickness=parseInt(matchEl.currentStyle.borderWidth),a.roundMarginTop=b.currentStyle.height+parseInt(b.currentStyle.marginTop)+parseInt(b.currentStyle.marginBottom)):(a.matchHeight=parseInt(document.defaultView.getComputedStyle(matchEl,"").getPropertyValue("height").replace("px","")),a.matchWidth=parseInt(document.defaultView.getComputedStyle(matchEl,"").getPropertyValue("width").replace("px","")),a.matchMarginH=parseInt(document.defaultView.getComputedStyle(matchEl,"").getPropertyValue("margin-right").replace("px","")),a.matchMarginV=parseInt(document.defaultView.getComputedStyle(matchEl,"").getPropertyValue("margin-top"))+parseInt(document.defaultView.getComputedStyle(matchEl,"").getPropertyValue("margin-bottom")),a.borderThickness=parseInt(document.defaultView.getComputedStyle(matchEl,"").getPropertyValue("border-right-width")),a.roundMarginTop=parseInt(document.defaultView.getComputedStyle(b,"").getPropertyValue("height").replace("px",""))+parseInt(document.defaultView.getComputedStyle(b,"").getPropertyValue("margin-top"))+parseInt(document.defaultView.getComputedStyle(b,"").getPropertyValue("margin-bottom"))),c.removeChild(matchEl),g=!0)}function e(d){var e=a.getMatches("C1");if(!e)return d.bracket.width="0 px",void(d.bracket.height="0 px");var f,g=0,h="DE"===a.getTournamentType();h&&(f=angular.module("ngBracket").findFirstRound(e),null!==f&&(d.startingRound1=f+1,g=Math.max(e[f].filter(b).length,e[f+1].filter(b).length),g+=Math.max(e[0].filter(c).length,e[1].filter(c).length)),d.lbOffset1=a.getProperties().lbOffset1*(d.matchHeight+d.matchMarginV)+d.roundMarginTop,g+=.5);var i=e.length;if(g=0!==g?g:Math.max(e[0].length,e[1].length),a.isDoubleConference()){e=a.getMatches(),f=angular.module("ngBracket").findFirstRound(e[2].matches),i=e[0].matches.length+1+e[2].matches.length+(h?2:0);var j=Math.max(e[2].matches[f].filter(b).length,e[2].matches[f+1].filter(b).length);j+=Math.max(e[2].matches[0].filter(c).length,e[2].matches[1].filter(c).length),h&&(d.startingRound2=f+1,j+=.5,d.lbOffset2=a.getProperties().lbOffset2*(d.matchHeight+d.matchMarginV)+d.roundMarginTop),g>j?d.paddingTopC2=(g-j)/2:(d.paddingTopC1=(j-g)/2,g=j),e=e[0].matches.length>e[2].matches.length?e[0].matches:e[2].matches}d.bracket.height=String(g*(d.matchHeight+d.matchMarginV)+d.roundMarginTop)+"px",d.bracket.width=String(i*(d.matchWidth+d.matchMarginH))+"px"}var f={matchHeight:null,matchWidth:null,matchMarginH:null,matchMarginV:null,borderThickness:null,roundMarginTop:null,startingRound1:null,startingRound2:null,lbOffset1:null,lbOffset2:null,paddingTopC1:null,paddingTopC2:null,bracket:{width:null,height:null}},g=!1;return{getProperties:function(){return g||(d(f),e(f)),f},refresh:function(){e(f)}}}]),app.directive("ngbracket",["data","layoutService",function(a,b){return{restrict:"E",templateUrl:"partials/bracket.html",replace:!1,scope:{bracketData:"="},controller:["$scope",function(c){c.bracketData&&(c.bracketData.reload=function(){a.loadTournament(c.bracketData),c.layoutProperties||(c.layoutProperties=b.getProperties()),b.refresh()})}]}}]).directive("doFocus",function(){return{restrict:"A",link:function(a,b){b&&(b[0].focus(),b[0].select())}}}).directive("teamContextMenu",["data",function(a){return{restrict:"A",scope:!1,link:function(b,c){function d(a){e.onTeamRightClick(a,b.team)}var e=a.getOptions();e.onTeamRightClick&&c.bind("contextmenu",d),b.$on("$destroy",function(){c.unbind("contextmenu",d)})}}}]).directive("onBeginRender",["data","connectorService","layoutService",function(a,b,c){return function(d,e){if(a.isDoubleConference()){var f,g=c.getProperties(),h=g.matchWidth+g.matchMarginH;if(d.$parent.$last&&d.$last){var i=e.parent()[0];for(f=i.childNodes.length;f--;)i.appendChild(i.childNodes[f])}if("DE"===a.getTournamentType())if(d.$last&&d.$parent.$first)d.prop=a.getProperties();else if(d.$last&&d.$parent.$last){d.prop=a.getProperties();var j=null,k=null,l=d.$watch("prop.finals2C2",function(a,c){if(null===j&&(j=angular.element(b.findConferenceFinals().C2_1.parentElement)),null===k)for(f=0;f<j[0].parentElement.children.length;f++)if(j[0].parentElement.children[f].classList.contains("connectors")){k=j[0].parentElement.children[f];break}if(a&&c===!1)for(j.css("left",j.prop("offsetLeft")+h+"px"),f=0;f<k.children.length;f++)angular.element(k.children[f]).css("left",k.children[f].offsetLeft+h+"px");else if(a===!1)for(j.css("left",j.prop("offsetLeft")-h+"px"),f=0;f<k.children.length;f++)angular.element(k.children[f]).css("left",k.children[f].offsetLeft-h+"px")},!0);d.$on("$destroy",function(){l()})}}}}]).directive("match",["connectorService","layoutService","data","$filter","highlight",function(a,b,c,d,e){return{restrict:"E",scope:!1,templateUrl:"partials/match.html",replace:!0,link:{pre:function(f,g){f.getTeamDetails=function(a,b){function e(a,b){return d("getById")(a,b)}var f=e(c.getTeams(b?b:1),a);return!b&&null===f&&c.isDoubleConference()&&(f=e(c.getTeams(2),a)),f};var h,i=f.match.meta.matchId.split("-");"C1"===i[1]&&(h=1),"C2"===i[1]&&(h=2),f.highlight=e.mapHighlight(),f.team1Details=f.getTeamDetails(f.match.team1.id,h),f.team2Details=f.getTeamDetails(f.match.team2.id,h);var j=f.$watch("match.team1",function(a){a&&(f.team1Details=f.getTeamDetails(f.match.team1.id,h))},!0),k=f.$watch("match.team2",function(a){a&&(f.team2Details=f.getTeamDetails(f.match.team2.id,h))},!0),l=parseInt(i[2]),m=parseInt(i[3]),n=b.getProperties(),o="C1"===i[1]?n.startingRound1:"C2"===i[1]?n.startingRound2:null;f.match.meta.team1Parent&&(f.team1Description="Loser of Round "+(parseInt(f.match.meta.team1Parent.split("-")[2])-o+1)+" match "+f.match.meta.team1Parent.split("-")[3]),f.match.meta.team2Parent&&(f.team2Description="Loser of Round "+(parseInt(f.match.meta.team2Parent.split("-")[2])-o+1)+" match "+f.match.meta.team2Parent.split("-")[3]),"finals2"===f.match.meta.matchType&&0===f.match.team1.id.length&&0===f.match.team2.id.length&&(f.team1Description="Finals round 2 if necessary",f.prop=c.getProperties(),"C1"===i[1]?f.conference=1:"C2"===i[1]&&(f.conference=2)),g.prop("id",f.match.meta.matchId),g.css("left",n.matchMarginH/2+"px"),"finals"==f.match.meta.matchType&&(f.finals=!0,c.isDoubleConference()&&2===h&&"DE"==c.getTournamentType()&&g.css("left",1.5*n.matchMarginH+n.matchWidth+"px"));var p="finals2"===f.match.meta.matchType&&"DE"===c.getTournamentType();p&&1===h&&g.css("left",1.5*n.matchMarginH+n.matchWidth+"px");var q=0,r="finals"===f.match.meta.matchType&&"DE"===c.getTournamentType(),s="L"===f.match.meta.matchId.slice(-1)||r?"-L":"";if(1===l||0===s.length&&l===o){var t=f.match.meta.UIShiftDown?f.match.meta.UIShiftDown:0;t+="C1"===i[1]&&n.paddingTopC1?n.paddingTopC1:"C2"===i[1]&&n.paddingTopC2?n.paddingTopC2:0,q=(n.matchHeight+n.matchMarginV)*(m-1+t)+n.roundMarginTop}else if(2===f.match.meta.matchType){var u="C1"===i[1]?n.paddingTopC1:"C2"===i[1]?n.paddingTopC2:0;q=(n.matchHeight+n.matchMarginV)*(m-1+u)+n.roundMarginTop;var v="C1"===i[1]?n.lbOffset1:"C2"===i[1]?n.lbOffset2:0;s.length>0&&v>0&&v>q&&(q+=v-n.roundMarginTop)}else if("bronze"===f.match.meta.matchType||p){var w=angular.element(document.getElementById("match-"+i[1]+"-"+i[2]+"-1"));q=w.prop("offsetTop"),"bronze"===f.match.meta.matchType&&(q+=n.matchHeight+40,f.bronzeMatch=!0)}else{var x=a.findConnectingMatch(f.match);if(q=angular.element(x[0].firstElementChild).prop("offsetTop"),"F"!==i[1]&&1!=f.match.meta.matchType)if(c.isDoubleConference()&&r&&"C2"===i[1]){var y=a.findConferenceFinals();q=y.C1.offsetTop}else{var z=x.scope().match.meta.matchId.split("-"),A=parseInt(z[3]),B="match-"+z[1]+"-"+(l-1)+"-"+(r?"1-L":A+1+s),C=angular.element(document.getElementById(B)),D=angular.element(C[0].firstElementChild).prop("offsetTop")+n.matchHeight;r?q+=(D-q)/4:q=q+(D-q)/2-n.matchHeight/2}"F"===i[1]&&"1"===i[3]&&(q-=n.matchHeight)}g.css("top",q+"px"),f.$on("$destroy",function(){j(),k()})},post:function(a,b){function d(){return{matchId:a.match.meta.matchId,team1:a.team1Details,team2:a.team2Details,results:a.match}}function e(a){g.onMatchClick(a,d())}function f(a){g.onMatchRightClick(a,d())}var g=c.getOptions();g.onMatchRightClick&&b.bind("contextmenu",f),g.onMatchClick&&b.bind("click",e),a.$on("$destroy",function(){b.unbind("contextmenu",f),b.unbind("click",e)})}}}}]).directive("score",["data",function(a){return{restrict:"E",scope:{team:"=",match:"=",results:"="},templateUrl:"partials/score.html",link:function(b){b.editScore=function(){b.match.team1.id&&b.match.team2.id&&(b.status="editable")},b.calculateResults=function(c){if("undefined"==typeof b.match.team1.score||""===b.match.team1.score||"undefined"==typeof b.match.team2.score||""===b.match.team2.score||b.match.team1.score===b.match.team2.score)return b.results.winner="",void(b.results.loser="");var d=a.getOptions();if(!d.onScoreChanged||d.onScoreChanged(b.match)){var e;b.match.team1.score>b.match.team2.score?(e=b.match.team1.id,b.results.loser=b.match.team2.id):(e=b.match.team2.id,b.results.loser=b.match.team1.id),b.results.winner=e;var f="DE"===a.getTournamentType()&&"L"!==b.match.meta.matchId.slice(-1);a.updateTournament(b.match,e,b.results.loser,c,f)}},b.endEditScore=function(){b.status="uneditable",b.calculateResults(null)};var c=b.$watch("match.team1.id",function(a,c){a&&b.calculateResults(c)},!0),d=b.$watch("match.team2.id",function(a,c){a&&b.calculateResults(c)},!0);b.$on("$destroy",function(){c(),d()})},replace:!0}}]).directive("connectors",["connectorService","layoutService","$compile","data",function(a,b,c,d){return{restrict:"E",template:'<div class="connectors"></div>',replace:!0,scope:!1,link:function(e,f){function g(a,b,d,f,g,h,i){var k=null===g?"cMatch1":"cMatch"+g.toString(),l=null===g?h?"tbdB:match.team1.id.length === 0 && match.team2.id.length === 0":"":1==g?"tbdB:match.team1.id.length === 0":"tbdB:match.team2.id.length === 0",m=i?k+".team1.score > "+k+".team2.score && ":"",n=i?k+".team2.score > "+k+".team1.score && ":"",o="highlight: highlight.teamId !== null && ((match.team1.id === highlight.teamId || match.team2.id === highlight.teamId) && (("+m+k+".team1.id === highlight.teamId) || ("+n+k+".team2.id === highlight.teamId)))",p="finals2"===e.match.meta.matchType?",hidden:(prop.finals2"+j[1]+" === false)":"",q='ng-class="{'+l+(l.length>0?", ":"")+o+p+'}"';return angular.element(c('<div class="connector" style="left:'+d+"px;top:"+f+"px;width:"+a+"px;height:"+b+'px" '+q+"></div>")(e))}function h(b,c,h,i){if(c>1&&(h||!h&&(c>b.startingRound1&&"C1"===j[1]||c>b.startingRound2&&"C2"===j[1]))){var k=a.findChildMatch(f.parent()),l=angular.element(a.findConnectingMatch(e.match)[0].firstElementChild);e.cMatch1=l.scope().match;var m,n=k.prop("offsetLeft")+b.borderThickness+(i?b.matchWidth:0),o=k.prop("offsetTop")+b.matchHeight/2;if(1===e.match.meta.matchType||"finals2"===e.match.meta.matchType){var p="L"===e.match.meta.matchId.slice(-1)||"finals2"===e.match.meta.matchType;return m=i?n:n-b.matchMarginH,void f.append(g(b.matchMarginH-b.borderThickness,1,m,o,null,p).addClass("connectorBottom"))}var q="DE"===d.getTournamentType()&&"finals"===e.match.meta.matchType,r=b.matchMarginH/2-b.borderThickness,s=o-l.prop("offsetTop")-b.matchHeight/2;m=i?n:n-r-b.borderThickness;var t=o-s,u=i?"connectorBottom connectorRight":"connectorBottom connectorLeft",v=g(r,s,m,t,1,null,q).addClass(u);f.append(v),m=i?m+r+b.borderThickness:m-r,f.append(g(r,1,m,t,1,null,q).addClass("connectorTop"));var w=l.scope().match.meta.matchId.split("-"),x="finals"===e.match.meta.matchType&&"DE"===d.getTournamentType(),y="L"==w.slice(-1)||x?"-L":"",z=w[0]+"-"+w[1]+"-"+w[2]+"-"+(x?1:parseInt(w[3])+1)+y,A=angular.element(a.findChildMatch(document.getElementById(z)));e.cMatch2=A.scope().match,s=A.prop("offsetTop")+b.matchHeight/2-o,m=i?n:n-r-b.borderThickness,t=o,u=i?"connectorTop connectorRight":"connectorTop connectorLeft",f.append(g(r,s,m,t,2).addClass(u)),m=i?m+r+b.borderThickness:m-r,t=o+s,f.append(g(r,1,m,t,2).addClass("connectorTop"))}}if(2!=e.match.meta.matchType&&"bronze"!=e.match.meta.matchType){var i=b.getProperties(),j=e.match.meta.matchId.split("-"),k=parseInt(j[2]),l="L"===e.match.meta.matchId.slice(-1);if("F"==j[1]){{var m=a.findConferenceFinals(),n=a.findChildMatch(f.parent()),o=n.prop("offsetTop")+i.matchHeight/2,p=n.prop("offsetLeft"),q=i.matchMarginH/2,r=m.C1.offsetTop-o+i.matchHeight/2;f.append(g(q,r,p-q,o,1).addClass("connectorTop connectorLeft"))}f.append(g(q,1,p-i.matchMarginH+i.borderThickness,o+r,1).addClass("connectorBottom")),e.cMatch1=angular.element(m.C1).scope(),p+=i.matchWidth+i.borderThickness,f.append(g(q,r,p,o,2).addClass("connectorTop connectorRight")),f.append(g(q,1,p+q,o+r,2).addClass("connectorBottom")),e.cMatch2=angular.element(m.C2).scope()}else h(i,k,l,"C2"==j[1])}}}}]).directive("team",["data","highlight",function(a,b){return{restrict:"E",templateUrl:"partials/team.html",replace:!0,scope:{team:"=",teamdetails:"=",description:"="},link:function(c,d){c.highlight=c.$parent.highlight,c.results=c.$parent.results,c.match=c.$parent.match,c.highlightTrack=function(a){b.setHighlight(a)},c.editTeam=function(){"Not started"===a.getProperties().status&&c.team.id&&(c.status="editable")},c.endEditTeam=function(){c.status="uneditable"};var e=a.getOptions();e.onTeamClick&&d.bind("click",e.onTeamClick),c.$on("$destroy",function(){d.unbind("click",e.onTeamClick)})}}}]),angular.module("ngBracket").factory("tournamentGenerator",function(){return{newTournament:function(a,b,c,d){function e(a,b,c){return{team1:{id:"",score:""},team2:{id:"",score:""},meta:{matchId:"match-"+c+"-"+a+"-"+b},details:{}}}function f(a,b,c){for(var d=[],e=c?2*a-b:b,f=c?a/Math.abs(2*a-b):a/b,g=0;a>g;g++)d[g]=c?2:0;for(g=0;e>g;g++){var h=Math.round(g*f);d[h]=c?d[h]-1:d[h]+1}return d}function g(a,b,c,d){function g(a,b){var c,d=0;for(c=0;c<a.length;c++)2!=a[c].meta.matchType&&(d+=1==a[c].meta.matchType?1:2);for(c=d;c<b.length;c++)b[c].meta.UIShiftDown=b[c].meta.UIShiftDown?b[c].meta.UIShiftDown+1:1}var h,i,j=[],k=1,l=null,m=0;if(1===b){for(;2*k<a.length;)k*=2;var n=a.length-k;if(n>0){m=n-k/2;var o=0===m?k:m>0?k+2*m:k-2*Math.abs(m);l=a.slice(o,a.length),a.splice(o,a.length)}}for(h=0;h<a.length;h++){if(i=e(b,j.length+1,d),1===b){if(h%2!==0)continue;i.team1.id=a[h].id,i.team2.id=a[h+1].id}else if(h%2!==0)continue;j.push(i)}var p;if(1===b&&null!==l&&l.length>0){c.matches.push(j.slice()),c.properties.unbalanced=!0;var q=[];if(0===m)for(h=0;h<l.length;h++)i=e(b+1,q.length+1,d),i.team1.id=l[h].id,i.meta.matchType=1,q.push(i);else if(m>0){p=f(k/2,l.length,!1);var r=0;for(h=0;h<p.length;h++)i=e(b+1,q.length+1,d),1===p[h]&&(i.team1.id=l[r].id,i.meta.matchType=1,r+=1),q.push(i)}else if(0>m){p=f(k/2,l.length,!0);var s=0;for(h=0;k/2>h;h++)i=e(b+1,q.length+1,d),i.team1.id=l[s].id,i.meta.matchType=1,2===p[h]&&(i.team2.id=l[s+1].id,i.meta.matchType=2,g(q,j),s+=1),s+=1,q.push(i)}return a=null,q}return a=null,j}function h(a,b,c,d,g){var h,i,j,k,l=[];if(!(1===b&&d.matches.length>1||d.properties.unbalanced&&2===b)){var m=b>2&&d.properties.unbalanced&&d.matches[0].length!==d.matches[1].length?1:0,n=!0;if(b>1){var o=c.length-1;for(j=0;j<c[o].length;j++)if(!c[o][j].meta.matchType){n=!1;break}}if(n&&3===b&&(d.matches[0].length<d.matches[1].length||c[0].length===c[1].length)&&(n=!1),(b+m)%2!==0||n)if(d.properties.unbalanced&&2>=b)if(a.length===d.matches[0].length)h=a.length;else{if(a.length>d.matches[0].length){for(c[0]=[],c[1]=[],j=0;j<d.matches[0].length;j++)c[0].push(e(1,j+1+"-L",g));var p=c[0].length>a.length/2;for(dist=f(a.length/2,c[0].length,p),j=0;j<a.length/2;j++)k=e(2,j+1+"-L",g),p?1===dist[j]&&(k.meta.matchType=1):k.meta.matchType=1===dist[j]?1:2,c[1].push(k);if(!p&&dist.length>c[0].length){var q=0,r=0;for(j=0;j<dist.length;j++)1!==dist[j]?q+=1:(c[0][r].meta.UIShiftDown=q,r+=1)}return}if(a.length<d.matches[0].length){c[0]=[],c[1]=[];var s=0;for(j=0;j<a.length;j++)1===a[j].meta.matchType?(k=e(2,j+1+"-L",g),k.meta.matchType=2,c[1].push(k),s+=1):(k=e(1,c[0].length+1+"-L",g),k.meta.UIShiftDown=s,c[0].push(k),k=e(2,j+1+"-L",g),k.meta.matchType=1,c[1].push(k));return}}else h=Math.floor(1===b?a.length/2:c[c.length-1].length/2);else h=Math.floor(c[c.length-1].length),i=!0;for(j=1;h>=j;j++)k=e(c.length+1,j+"-L",g),i&&(k.meta.matchType=1),l.push(k);if(c.push(l),1===a.length)for(;1!==c[c.length-1].length||1!==c[c.length-2].length;){b+=1;var t=[];for(h=Math.floor((b+m)%2===0?c[c.length-1].length:c[c.length-1].length/2),i=(b+m)%2===0,0===h&&(h=1,i=!0),j=1;h>=j;j++)k=e(c.length+1,j+"-L",g),i&&(k.meta.matchType=1),t.push(k);c.push(t)}}}function i(a,b,c,d){var f=[],i=[],l=1,m=k();for(m.matches=[];1===l||Math.floor(f.length)>1;){var n=f;1===l&&(n=b.slice()),f=g(n,l,m,d),"DE"===m.type&&h(f,l,i,m,d),m.matches.push(f.slice()),l=m.matches.length+1}if("DE"===m.type){for(var o=Math.max(m.matches[0].length,m.matches[1].length)+.5,p=0;p<i[0].length;p++)i[0][p].meta.UIShiftDown=isNaN(i[0][p].meta.UIShiftDown)?o:i[0][p].meta.UIShiftDown+o,m.properties.lbOffset=o;o=i.length-m.matches.length;var q,r,s,t=0;if(m.properties.unbalanced){if(m.matches[0].length===m.matches[1].length)for(p=0;2>p;p++)for(q=m.matches[p].length,j=0;j<m.matches[p].length;j++)r="match-"+d+"-"+(p+1+o)+"-"+(j+1),m.matches[p][j].meta.matchId=r,p>0?(i[0][q-1-j].meta.team2Parent=r,m.matches[p][j].meta.loserMatchId=i[0][q-1-j].meta.matchId):(i[0][j].meta.team1Parent=r,m.matches[p][j].meta.loserMatchId=i[0][j].meta.matchId);else if(m.matches[0].length>m.matches[1].length){var u=0,v=0;for(p=0;2>p;p++)for(q=m.matches[p].length,j=0;q>j;j++)m.matches[p][j].meta.matchId="match-"+d+"-"+(p+1+o)+"-"+(j+1),p>0&&(1===m.matches[p][j].meta.matchType?(i[p][j].meta.matchType=2,i[p][j].meta.team1Parent=m.matches[0][u].meta.matchId,i[p][j].meta.team2Parent="match-"+(p+1+o)+"-"+(q-j),m.matches[0][u].meta.loserMatchId=i[p][j].meta.matchId,m.matches[p][q-j-1].meta.loserMatchId=i[p][j].meta.matchId,u+=1):(i[p][j].meta.matchType=1,i[0][v].meta.team1Parent=m.matches[0][u].meta.matchId,i[0][v].meta.team2Parent=m.matches[0][u+1].meta.matchId,i[p][j].meta.team1Parent="match-"+(p+1+o)+"-"+(q-j),m.matches[0][u].meta.loserMatchId=i[0][v].meta.matchId,m.matches[0][u+1].meta.loserMatchId=i[0][v].meta.matchId,m.matches[p][q-j-1].meta.loserMatchId=i[p][j].meta.matchId,v+=1,u+=2))}else if(m.matches[0].length<m.matches[1].length){var w=!1;for(p=0;2>p;p++)for(q=m.matches[p].length,j=0;q>j;j++)if(r="match-"+d+"-"+(p+1+o)+"-"+(j+1),m.matches[p][j].meta.matchId=r,0===p)i[p][j].meta.team1Parent=r,m.matches[p][j].meta.loserMatchId=i[p][j].meta.matchId;else if(m.matches[p][j].meta.matchType)if(w)for(s=0;s<i[1].length;s++){if(!(1!==i[1][s].meta.matchType&&2!==i[1][s].meta.matchType||i[1][s].meta.team1Parent)){i[1][s].meta.team1Parent=r,m.matches[p][j].meta.loserMatchId=i[1][s].meta.matchId;break}if(2===i[1][s].meta.matchType&&!i[1][s].meta.team2Parent){i[1][s].meta.team2Parent=r,m.matches[p][j].meta.loserMatchId=i[1][s].meta.matchId;break}}else i[0][i[0].length-j-1].meta.team2Parent=r,m.matches[p][j].meta.loserMatchId=i[0][i[0].length-j-1].meta.matchId,w=j===i[0].length-1}t=2}for(p=t;p<m.matches.length;p++){var x=2>p?p:2*p-1,y=0;for(m.properties.unbalanced&&(x-=1,y=1),p===m.matches.length-1&&(x=i.length-1),q=m.matches[p].length,j=0;q>j;j++){var z="match-"+d+"-"+(x+1)+"-";for(z+=0===p?Math.floor(j/2)+1:(p+y)%2===0?j+1:q-j,z+="-L",r="match-"+d+"-"+(p+1+o)+"-"+(j+1),s=i[x].length-1;s>=0;s--)if(i[x][s].meta.matchId===z){i[x][s].meta.team1Parent?i[x][s].meta.team2Parent=r:i[x][s].meta.team1Parent=r;break}m.matches[p][j].meta.matchId=r,m.matches[p][j].meta.loserMatchId=z}}for(j=m.matches.length-1,p=i.length-1;p>=0;p--)j>=0?m.matches[j]=m.matches[j].concat(i[p]):m.matches.unshift(i[p]),j-=1;m.matches.push(new Array(e(m.matches.length+1,1,d)));var A=e(m.matches.length,m.matches[m.matches.length-1].length+1,d);A.meta.matchType="finals2",m.matches[m.matches.length-1].push(A)}if(m.matches[m.matches.length-1][0].meta.matchType="finals",c){var B=e(m.matches.length,m.matches[m.matches.length-1].length+1,d);B.meta.matchType="bronze",m.matches[m.matches.length-1].push(B)}return m}function k(){return{type:a,conferences:[],properties:{status:"Not started"}}}var l=k();if(!d&&b.length<3||d&&2!==b.length)return l;if(d){l.doubleConference=!0;var m=i(a,b[0],!1,"C1");if(!m)return;l.conferences.push({matches:m.matches.slice()}),l.properties.lbOffset1=m.properties.lbOffset,m={conferenceName:"Finals",matches:[[]]};var n=e("F",1,"F");if(n.meta.matchType="finals",m.matches[0].push(n),c&&(n=e("F",2,"F"),n.meta.matchType="bronze",m.matches[0].push(n)),l.conferences.push(m),m=null,m=i(a,b[1],!1,"C2"),!m)return;l.conferences.push({matches:m.matches.slice()}),l.properties.lbOffset2=m.properties.lbOffset}else{var o=i(a,b,c,"C1");l.conferences.push({matches:o.matches.slice()}),l.properties.lbOffset1=o.properties.lbOffset}return l},shuffle:function(a){if(a&&a.teams&&a.tournament&&"Not started"==a.tournament.properties.status){for(var b,c,d=a.tournament,e=a.teams.length,f=a.teams.slice();0!==e;)c=Math.floor(Math.random()*e),e-=1,b=f[e],f[e]=f[c],f[c]=b;var g,h=0,i="DE"===d.type?angular.module("ngBracket").findFirstRound(d.matches):0;for(g=0;g<d.matches[i].length&&"L"!==d.matches[i][g].meta.matchId.slice(-1);g++)d.matches[i][g].team1.id=f[h].id,d.matches[i][g].team2.id=f[h+1].id,h+=2;if(d.properties.unbalanced)for(i+=1,g=0;g<d.matches[i].length&&!(h>=f.length||"L"===d.matches[i][g].meta.matchId.slice(-1));g++)1===d.matches[i][g].meta.matchType?(d.matches[i][g].team1.id=f[h].id,h+=1):2===d.matches[i][g].meta.matchType&&(d.matches[i][g].team1.id=f[h].id,d.matches[i][g].team2.id=f[h+1].id,h+=2)}}}});